{% extends "base.html" %}
{% load staticfiles %}
{% load i18n %}
{% load visorxml %}
{% load formset_tags %}

{% block title %}{% trans "Visor de informes" %}{% endblock %}

{% block content %}


<div class="page hidden-print">
  <hr>
  <p class="lead">
    {% blocktrans %}
    Seleccione un archivo de informe de eficiencia energética en XML
    {% endblocktrans %}
  </p>
  <p>
    {% static "docs/EjemploTerciario.xml" as xml_example_1_url %}
    {% static "docs/EjemploResidencial.xml" as xml_example_2_url %}
    {% blocktrans %}
    Puede probar la validación con un <a href="{{ xml_example_1_url }}">informe de ejemplo de edificio con uso
    terciario</a> o con un <a href="{{ xml_example_2_url }}">informe de ejemplo de edificio con uso residencial</a>.
    {% endblocktrans %}
  </p>

  <div class="panel panel-primary">
    <div class="panel-heading">
      {% trans "Selección de archivos de informe de evaluación de la eficiencia energética." %}
    </div>
    <div class="panel-body">
      <div class="form-group col-md-6">
        <form action="{% url "validator" %}" class="form" method="POST" enctype="multipart/form-data">
          {% csrf_token %}

          <div id="formset">
            <div class="panel panel-default">
            <div class="panel-heading">
              <h5>{% trans "Informe de evaluación de la eficiencia energética en formato XML." %}</h5>
              <h5>{% trans "Archivo base:" %}</h5>
            </div>
            <div class="panel-body">
              <div data-formset-body>
                <div class="form-group" data-formset-form>
                  <input id="certificate-file" name="certificate-file" type="file" class="file-input" />
                </div>
              </div>

            </div>
            <div class="panel-footer">
              <button type="submit" class="btn btn-primary">{% trans "Validar" %}</button>
            </div>
          </div>
          </div>
        </form>
      </div>

      <div class="col-md-6">
        {% if validation_data %}
          {% if validation_data.extra_files_errors %}
            <div class="alert alert-warning">
              <h2>{% trans "Archivos de mejora" %}</h2>
              <p>
                Se han encontrado <strong>{{ validation_data.extra_files_errors|length }}</strong> errores al tratar los
                archivos de mejora:
              </p>
              <ul>
                {% for filename, errors in validation_data.extra_files_errors.items %}
                  <li>
                    <strong>{{ filename }}</strong>:
                    <ul>
                    {% for error in errors %}
                      <li>{{ error }}</li>
                    {% endfor %}
                    </ul>
                  </li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}


          {% if validation_data.validation_errors %}
            <div class="alert alert-danger">
              <h2>{% trans "Errores de validación" %}</h2>
              <p>
                Se han encontrado <strong>{{ validation_data.validation_errors|length }}</strong> errores de
                validación en el archivo {{ request.session.base_name }}:
              </p>
              <ul>
                {% for error in validation_data.validation_errors %}
                  <li>
                    {% if error.0 %}
                      <strong>Línea {{ error.0 }}:</strong>
                    {% endif %}
                    {{ error.1|safe }}
                  </li>
                {% endfor %}
              </ul>
            </div>
          {% else %}
            <div class="alert alert-success">
              <p>El informe activo, no contiene errores de validación.</p>
              {# <p>Puede <a href="{{ url_for('visor')}}" class="alert-link">ver su contenido</a> o seleccionar un nuevo informe para su validación.</p>#}
            </div>
          {% endif %}

          {% if validation_data.info %}
            <div class="alert alert-warning">
              <h2>Avisos de validación</h2>
              <p>Se han encontrado <strong>{{ validation_data.info|length }}</strong> avisos de validación:</p>
              <ul>
                {% for messagetype, message, id in validation_data.info %}
                  <li><strong>{{ messagetype }}:</strong> {{ message }} | #{{id}}</li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}

        {% else %}
          <div class="alert alert-warning">
            <p>No existe un informe activo.</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% if validated %}
<div class="page">
  <nav class="hidden-print">

  </nav>

  <div class="informe" id="informe">
    <h2 class="text-center">CERTIFICADO DE EFICIENCIA ENERGÉTICA DE EDIFICIOS</h2>

    <div class="section">
      <h4>IDENTIFICACIÓN DEL EDIFICIO O DE LA PARTE QUE SE CERTIFICA:</h4>

      <table class="top">
        <tr>
          <td class="title" width="30%">Nombre del Edificio</td>
          <td colspan="3">
            <a href="#" class="editable" id="IdentificacionEdificio.NombreDelEdificio">
              {{ report.data.IdentificacionEdificio.NombreDelEdificio }}
            </a>
          </td>
        </tr>
        <tr>
          <td class="title">Dirección</td>
          <td colspan="3">
            <a href="#" class="editable" id="IdentificacionEdificio.Direccion">
              {{ report.data.IdentificacionEdificio.Direccion }}
            </a>
          </td>
        </tr>
        <tr>
          <td class="title">Municipio</td>
          <td>
            <a href="#" class="editable" id="IdentificacionEdificio.Municipio">
              {{ report.data.IdentificacionEdificio.Municipio }}
            </a>
          </td>
          <td class="title" width="15%">Código Postal</td>
          <td>
            <a href="#" class="editable" id="IdentificacionEdificio.CodigoPostal">
              {{ report.data.IdentificacionEdificio.CodigoPostal }}
            </a>
          </td>
        </tr>
        <tr>
          <td class="title">Provincia</td>
          <td>
            <a href="#" class="editable" id="IdentificacionEdificio.Provincia">
              {{ report.data.IdentificacionEdificio.Provincia }}
            </a>
          </td>
          <td class="title" width="15%">Comunidad Autónoma</td>
          <td>
            <a href="#" class="editable" id="IdentificacionEdificio.ComunidadAutonoma">
              {{ report.data.IdentificacionEdificio.ComunidadAutonoma }}
            </a>
          </td>
        </tr>
        <tr>
          <td class="title">Zona climática</td>
          <td>
            <a href="#" class="editable" id="IdentificacionEdificio.ZonaClimatica">
              {{ report.data.IdentificacionEdificio.ZonaClimatica }}
            </a>
          </td>
          <td class="title" width="15%">Año construcción</td>
          <td>
            <a href="#" class="editable" id="IdentificacionEdificio.AnoConstruccion">
              {{ report.data.IdentificacionEdificio.AnoConstruccion }}
            </a>
          </td>
        </tr>
        <tr>
          <td class="title">Plantas sobre rasante</td>
          <td>
            <a href="#" class="editable" id="DatosGeneralesyGeometria.NumeroDePlantasSobreRasante">
              {{ report.data.DatosGeneralesyGeometria.NumeroDePlantasSobreRasante }}
            </a>
          </td>
          <td class="title" width="15%">Plantas bajo rasante</td>
          <td>
            <a href="#" class="editable" id="DatosGeneralesyGeometria.NumeroDePlantasBajoRasante">
              {{ report.data.DatosGeneralesyGeometria.NumeroDePlantasBajoRasante }}
            </a>
          </td>
        </tr>
        <tr>
          <td class="title">Normativa vigente (construcción / rehabilitación)</td>
          <td colspan="3">
            <a href="#" class="editable" id="IdentificacionEdificio.NormativaVigente">
              {{ report.data.IdentificacionEdificio.NormativaVigente }}
            </a>
          </td>
        </tr>
        <tr>
          <td class="title">Referencia/s catastral/es</td>
          <td colspan="3">
            <a href="#" class="editable" id="IdentificacionEdificio.ReferenciaCatastral">
              {{ report.data.IdentificacionEdificio.ReferenciaCatastral }}
            </a>
          </td>
        </tr>
      </table>

      <br />

      <table>
        <tr><td class="title" colspan="2">Tipo de edificio o parte del edificio que se certifica:</td></tr>
        <tr>
          <td width="50%">
            <span style="margin-left:20px" />
            {% if 'Nuevo' in report.data.IdentificacionEdificio.AlcanceInformacionXML %}
              <span class="glyphicon glyphicon-bordered glyphicon-remove" aria-hidden="true"></span>
            {% else %}
              <span class="glyphicon glyphicon-bordered glyphicon-empty" aria-hidden="true"></span>
            {% endif %} Edificio de nueva construcción
          </td>
          <td><span style="margin-left:20px" />
            {% if 'Existente' in report.data.IdentificacionEdificio.AlcanceInformacionXML %}
              <span class="glyphicon glyphicon-bordered glyphicon-remove" aria-hidden="true"></span>
            {% else %}
              <span class="glyphicon glyphicon-bordered glyphicon-empty" aria-hidden="true"></span>
            {% endif %} Edificio existente</td>
        </tr>
        <tr><td class="title" colspan="2">&nbsp;</td></tr>
        <tr>
          <td>
            <span style="margin-left:20px" />
            {% if 'Vivienda' in report.data.IdentificacionEdificio.TipoDeEdificio %}
              <span class="glyphicon glyphicon-bordered glyphicon-remove" aria-hidden="true"></span>
            {% else %}
              <span class="glyphicon glyphicon-bordered glyphicon-empty" aria-hidden="true"></span>
            {% endif %} Vivienda<br />
            <span style="margin-left:40px" />
            {% if 'Unifamiliar' in report.data.IdentificacionEdificio.TipoDeEdificio %}
              <span class="glyphicon glyphicon-bordered glyphicon-remove" aria-hidden="true"></span>
            {% else %}
              <span class="glyphicon glyphicon-bordered glyphicon-empty" aria-hidden="true"></span>
            {% endif %} Unifamiliar<br />
            <span style="margin-left:40px" />
            {% if 'Bloque' in report.data.IdentificacionEdificio.TipoDeEdificio %}
              <span class="glyphicon glyphicon-bordered glyphicon-remove" aria-hidden="true"></span>
            {% else %}
              <span class="glyphicon glyphicon-bordered glyphicon-empty" aria-hidden="true"></span>
            {% endif %} Bloque<br />
            <span style="margin-left:60px" />
            {% if 'Completo' in report.data.IdentificacionEdificio.TipoDeEdificio %}
              <span class="glyphicon glyphicon-bordered glyphicon-remove" aria-hidden="true"></span>
            {% else %}
              <span class="glyphicon glyphicon-bordered glyphicon-empty" aria-hidden="true"></span>
            {% endif %} Bloque Completo<br />
            <span style="margin-left:60px" />
            {% if 'EnBloque' in report.data.IdentificacionEdificio.TipoDeEdificio %}
              <span class="glyphicon glyphicon-bordered glyphicon-remove" aria-hidden="true"></span>
            {% else %}
              <span class="glyphicon glyphicon-bordered glyphicon-empty" aria-hidden="true"></span>
            {% endif %} Vivienda individual
          </td>
          <td>
            <span style="margin-left:20px" />
            {% if 'Terciario' in report.data.IdentificacionEdificio.TipoDeEdificio %}
              <span class="glyphicon glyphicon-bordered glyphicon-remove" aria-hidden="true"></span>
            {% else %}
              <span class="glyphicon glyphicon-bordered glyphicon-empty" aria-hidden="true"></span>
            {% endif %} Terciario<br />
            <span style="margin-left:40px" />
            {% if 'EdificioUsoTerciario' in report.data.IdentificacionEdificio.TipoDeEdificio %}
              <span class="glyphicon glyphicon-bordered glyphicon-remove" aria-hidden="true"></span>
            {% else %}
              <span class="glyphicon glyphicon-bordered glyphicon-empty" aria-hidden="true"></span>
            {% endif %} Edificio completo<br />
            <span style="margin-left:40px" />
            {% if 'Local' in report.data.IdentificacionEdificio.TipoDeEdificio %}
              <span class="glyphicon glyphicon-bordered glyphicon-remove" aria-hidden="true"></span>
            {% else %}
              <span class="glyphicon glyphicon-bordered glyphicon-empty" aria-hidden="true"></span>
            {% endif %} Local
          </td>
        </tr>
      </table>
    </div>

    <br />

    <div class="section">
      <h4>DATOS DEL TÉCNICO CERTIFICADOR:</h4>

      <table class="top">
        <tr>
          <td class="title" width="30%">Nombre y Apellidos</td>
          <td>
            <a href="#" class="editable" id="DatosDelCertificador.NombreyApellidos">
              {{ report.data.DatosDelCertificador.NombreyApellidos }}
            </a>
          </td>
          <td class="title" width="17%">NIF/NIE</td>
          <td>
            <a href="#" class="editable" id="DatosDelCertificador.NIF">
              {{ report.data.DatosDelCertificador.NIF }}
            </a>
          </td>
        </tr>
        <tr>
          <td class="title">Razón Social</td>
          <td>
            <a href="#" class="editable" id="DatosDelCertificador.RazonSocial">
              {{ report.data.DatosDelCertificador.RazonSocial }}
            </a>
          </td>
          <td class="title">NIF</td>
          <td>
            <a href="#" class="editable" id="DatosDelCertificador.NIFEntidad">
              {{ report.data.DatosDelCertificador.NIFEntidad }}
            </a>
          </td>
        </tr>
        <tr>
          <td class="title">Domicilio</td>
          <td colspan="3">
            <a href="#" class="editable" id="DatosDelCertificador.Domicilio">
              {{ report.data.DatosDelCertificador.Domicilio }}
            </a>
          </td>
        </tr>
        <tr>
          <td class="title">Municipio</td>
          <td>
            <a href="#" class="editable" id="DatosDelCertificador.Municipio">
              {{ report.data.DatosDelCertificador.Municipio }}
            </a>
          </td>
          <td class="title">Código Postal</td>
          <td>
            <a href="#" class="editable" id="DatosDelCertificador.CodigoPostal">
              {{ report.data.DatosDelCertificador.CodigoPostal }}
            </a>
          </td>
        </tr>
        <tr>
          <td class="title">Provincia</td>
          <td>
            <a href="#" class="editable" id="DatosDelCertificador.Provincia">
              {{ report.data.DatosDelCertificador.Provincia }}
            </a>
          </td>
          <td class="title">Comunidad Autónoma</td>
          <td>
            <a href="#" class="editable" id="DatosDelCertificador.ComunidadAutonoma">
              {{ report.data.DatosDelCertificador.ComunidadAutonoma }}
            </a>
          </td>
        </tr>
        <tr>
          <td class="title">e-mail</td>
          <td>
            <a href="#" class="editable" id="DatosDelCertificador.Email">
              {{ report.data.DatosDelCertificador.Email }}
            </a>
          </td>
          <td class="title">Teléfono</td>
          <td>
            <a href="#" class="editable" id="DatosDelCertificador.Telefono">
              {{ report.data.DatosDelCertificador.Telefono }}
            </a>
          </td>
        </tr>
        <tr>
          <td class="title">Titulación habilitante según normativa vigente</td>
          <td colspan="3">
            <a href="#" class="editable" id="DatosDelCertificador.Titulacion">
              {{ report.data.DatosDelCertificador.Titulacion }}
            </a>
          </td>
        </tr>
        <tr>
          <td class="title" colspan="2">Procedimiento reconocido de calificación energética utilizado y versión:</td>
          <td colspan="2">
            <a href="#" class="editable" id="DatosDelCertificador.Procedimiento">
              {{ report.data.IdentificacionEdificio.Procedimiento }}
            </a>
          </td>
        </tr>
      </table>
    </div>

    <br />

    <div class="section">
      <h4>CALIFICACIÓN ENERGÉTICA OBTENIDA:</h4>

      <div class="calif">
        <table>
          <tr>
            <td class="title">CONSUMO DE ENERGÍA PRIMARIA NO RENOVABLE<br />[kWh/m<sup>2</sup>·año]</td>
            <td class="title">EMISIONES DE DIÓXIDO DE CARBONO<br />[kgCO<sub>2e</sub>/m<sup>2</sup>·año]</td>
          </tr>
          <tr>
            <td>{% if report.data.Consumo.EnergiaPrimariaNoRenovable.Global %}<img class="escala" src="{% escalasvg report.data.Consumo.EnergiaPrimariaNoRenovable.Global report 'EnergiaPrimariaNoRenovable' %}" />{% endif %}</td>
            <td>{% if report.data.EmisionesCO2.Global %}<img class="escala" src="{% escalasvg report.data.EmisionesCO2.Global report 'EmisionesCO2' %}" />{% endif %}</td>
          </tr>
        </table>
      </div>

      <p>El técnico certificador abajo firmante certifica que ha realizado la calificación energética del edificio o de la parte que se certifica
        de acuerdo con el procedimiento establecido por la normativa vigente y que son ciertos los datos que figuran en el presente
        documento, y sus anexos:</p>

      <p>Fecha: {{ report.data.DatosDelCertificador.Fecha }}</p>
      <br />
      <p class="text-center">Firma del técnico certificador: {{ report.data.DatosDelCertificador.NombreyApellidos}} - {{ report.data.DatosDelCertificador.NIF}}</p>

      <ol>
        <li><strong>Anexo I. </strong>Descripción de las características energéticas del edificio.</li>
        <li><strong>Anexo II. </strong>Calificación energética del edificio.</li>
        <li><strong>Anexo III. </strong>Recomendaciones para la mejora de la eficiencia energética.</li>
        <li><strong>Anexo IV. </strong>Pruebas, comprobaciones e inspecciones realizadas por el técnico certificador.</li>
      </ol>
      <p>Registro del Órgano Territorial Competente:</p>
    </div>
    <!-- Falta tabla de pie de página (ver modelo )-->

    <div class="page-break"></div>
    <!-- ANEXO I - Descripción del edificio -->
    <h3 class="text-center" id="anexo-I">ANEXO I<br />DESCRIPCIÓN DE LAS CARACTERÍSTICAS ENERGÉTICAS DEL EDIFICIO</h3>

    <p>En este apartado se describen las características energéticas del edificio, envolvente térmica, instalaciones, condiciones de
      funcionamiento y ocupación y demás datos utilizados para obtener la calificación energética del edificio.</p>

    <h4>1. SUPERFICIE, IMAGEN Y SITUACIÓN</h4>

    <table>
      <tr>
        <td class="title col-md-5">Superficie habitable [m<sup>2</sup>]</td>
        <td class="col-md-7">{{ report.data.DatosGeneralesyGeometria.SuperficieHabitable|asnum }}</td>
      </tr>
    </table>

    <br />

    <table class="fotos">
      <tr>
        <td class="title col-md-6">Imagen del Edificio</td>
        <td class="title col-md-6">Plano de situación</td>
      </tr>
      <tr>
        <td class="col-md-6" align="center">
          <a href="#" class="upload-image" data-section="Imagen" id="DatosGeneralesyGeometria.Imagen"
            {% if report.data.DatosGeneralesyGeometria.Imagen %}
               style=" background-image: url('{{ report.data.DatosGeneralesyGeometria.Imagen }}'); "
            {% else %}
                style=" background-image: url('{% static 'img/sinimagen.svg' %}'); "
            {% endif %}
            >
            <div><img src="{% static 'img/edit.png'%}" alt=""/></div>
          </a>
        </td>

        <td class="col-md-6" align="center">
          <a href="#" class="upload-image" data-section="Plano" id="DatosGeneralesyGeometria.Plano"
            {% if report.data.DatosGeneralesyGeometria.Plano %}
                style=" background-image: url('{{ report.data.DatosGeneralesyGeometria.Plano }}'); "
            {% else %}
                style=" background-image: url('{% static 'img/sinimagen.svg' %}'); "
            {% endif %}
            >
            <div><img src="{% static 'img/edit.png'%}" alt=""/></div>
          </a>
        </td>
      </tr>
    </table>

    <div class="section">
      <h4>2. ENVOLVENTE TÉRMICA</h4>

      <h5>Cerramientos opacos</h5>

      <table class="table-hover">
        <tr>
          <td width="30%" class="title">Nombre</td>
          <td width="10%" class="title">Tipo</td>
          <td width="17%" class="title">Superficie [m<sup>2</sup>]</td>
          <td class="title">Transmitancia [W/m<sup>2</sup>·K]</td>
          <td width="20%" class="title">Modo de obtención</td>
        </tr>
        {% for e in report.data.DatosEnvolventeTermica.CerramientosOpacos %}
        <tr>
          <td>{{ e.Nombre }}</td>
          <td>{{ e.Tipo }}</td>
          <td class="num">{{ e.Superficie|asnum}}</td>
          <td class="num">{{ e.Transmitancia|asnum }}</td>
          <td>{{ e.ModoDeObtencion }}</td>
        </tr>
        {% endfor %}
      </table>
    </div>

    <div class="section">
      <h5>Huecos y lucernarios</h5>

      <table>
        <tr>
          <td width="30%" class="title">Nombre</td>
          <td width="8%" class="title">Tipo</td>
          <td width="12%" class="title">Superficie [m<sup>2</sup>]</td>
          <td class="title">Transmitancia [W/m<sup>2</sup>·K]</td>
          <td width="8%" class="title">Factor solar</td>
          <td width="14%" class="title">Modo de obtención.<br />Transmitancia</td>
          <td width="14%" class="title">Modo de obtención.<br />Factor solar</td>
        </tr>
        <tr>
          {% for e in report.data.DatosEnvolventeTermica.HuecosyLucernarios %}
        <tr>
          <td>{{ e.Nombre }}</td>
          <td>{{ e.Tipo }}</td>
          <td class="num">{{ e.Superficie|asnum }}</td>
          <td class="num">{{ e.Transmitancia|asnum }}</td>
          <td class="num">{{ e.FactorSolar|asnum }}</td>
          <td>{{ e.ModoDeObtencionTransmitancia }}</td>
          <td>{{ e.ModoDeObtencionFactorSolar }}</td>
        </tr>
        {% endfor %}
        </tr>
      </table>
    </div>

    <div class="section">
      <h4>3. INSTALACIONES TÉRMICAS</h4>

      <h5>Generadores de calefacción</h5>

      <table>
        <tr>
          <td width="23%" class="title">Nombre</td>
          <td width="20%" class="title">Tipo</td>
          <td class="title">Potencia nominal [kW]</td>
          <td class="title">Rendimiento estacional [%]</td>
          <td width="20%" class="title">Tipo de energía</td>
          <td width="12%" class="title">Modo de obtención</td>
        </tr>
        {% for e in report.data.InstalacionesTermicas.GeneradoresDeCalefaccion %}
        <tr>
          <td>{{ e.Nombre }}</td>
          <td>{{ e.Tipo }}</td>
          <td class="num">{{ e.PotenciaNominal|asnum }}</td>
          <td class="num">{{ e.RendimientoEstacional|aspct }}</td>
          <td>{{ e.VectorEnergetico }}</td>
          <td>{{ e.ModoDeObtencion }}</td>
        </tr>
        {% endfor %}
        <tr>
          <td class="total text-center">TOTALES</td>
          <td class="shade"></td>
          <td class="total num calc">{{ report.data.InstalacionesTermicas.totalpotenciageneradoresdecalefaccion|asnum }}</td>
          <td class="shade"></td>
          <td class="shade"></td>
          <td class="shade"></td>
        </tr>
      </table>
    </div>

    <div class="section">
      <h5>Generadores de refrigeración</h5>

      <table>
        <tr>
          <td width="23%" class="title">Nombre</td>
          <td width="20%" class="title">Tipo</td>
          <td class="title">Potencia nominal [kW]</td>
          <td class="title">Rendimiento estacional [%]</td>
          <td width="20%" class="title">Tipo de energía</td>
          <td width="12%" class="title">Modo de obtención</td>
        </tr>
        {% for e in report.data.InstalacionesTermicas.GeneradoresDeRefrigeracion %}
        <tr>
          <td>{{ e.Nombre }}</td>
          <td>{{ e.Tipo }}</td>
          <td class="num">{{ e.PotenciaNominal|asnum }}</td>
          <td class="num">{{ e.RendimientoEstacional|aspct }}</td>
          <td>{{ e.VectorEnergetico }}</td>
          <td>{{ e.ModoDeObtencion }}</td>
        </tr>
        {% endfor %}
        <tr>
          <td class="total text-center">TOTALES</td>
          <td class="shade"></td>
          <td class="total num calc">{{ report.data.InstalacionesTermicas.totalpotenciageneradoresderefrigeracion|asnum }}</td>
          <td class="shade"></td>
          <td class="shade"></td>
          <td class="shade"></td>
        </tr>
      </table>
    </div>

    <div class="section">
      <h5>Instalaciones de Agua Caliente Sanitaria</h5>

      <table style="width:65%">
        <tr>
          <td width="45%" class="title">Demanda diaria de ACS a 60ºC (litros/dia)</td>
          <td width="20%" class="num">{{ report.data.DatosGeneralesyGeometria.DemandaDiariaACS|asnum }}</td>
        </tr>
      </table>

      <br />

      <table>
        <tr>
          <td width="23%" class="title">Nombre</td>
          <td width="20%" class="title">Tipo</td>
          <td class="title">Potencia nominal [kW]</td>
          <td class="title">Rendimiento estacional [%]</td>
          <td width="20%" class="title">Tipo de energía</td>
          <td width="12%" class="title">Modo de obtención</td>
        </tr>
        {% for e in report.data.InstalacionesTermicas.InstalacionesACS %}
        <tr>
          <td>{{ e.Nombre }}</td>
          <td>{{ e.Tipo }}</td>
          <td class="num">{{ e.PotenciaNominal|asnum }}</td>
          <td class="num">{{ e.RendimientoEstacional|aspct }}</td>
          <td>{{ e.VectorEnergetico }}</td>
          <td>{{ e.ModoDeObtencion }}</td>
        </tr>
        {% endfor %}
      </table>
    </div>

    <div class="section">
      <h5>Sistemas secundarios de calefacción y/o refrigeración (sólo edificios terciarios)</h5>
      {% if not  report.data.InstalacionesTermicas.SistemasSecundariosCalefaccionRefrigeracion %}
        <table><tr><td class="report-warning">No se han definido sistemas secundarios de calefacción y/o refrigeración</td></tr></table>
      {% endif %}

      {% for e in report.data.InstalacionesTermicas.SistemasSecundariosCalefaccionRefrigeracion|default:' ' %}
      <table>
        <tr>
          <td class="title" width="25%">Nombre</td>
          <td colspan="3">{{ e.Nombre }}</td>
        </tr>
        <tr>
          <td class="title" width="25%">Tipo</td>
          <td colspan="3">{{ e.Tipo }}</td>
        </tr>
        <tr>
          <td class="title" width="25%">Zona asociada</td>
          <td colspan="3">{{ e.ZonaAsociada }}</td>
        </tr>
        <tr>
          <td class="title" width="25%">Potencia calor [kW]</td>
          <td class="title" width="25%">Potencia frío [kW]</td>
          <td class="title" width="25%">Rendimiento estacional calor [%]</td>
          <td class="title" width="25%">Rendimiento estacional frío [%]</td>
        </tr>
        <tr>
          <td class="num">{{ e.PotenciaCalor|asnum }}</td>
          <td class="num">{{ e.PotenciaFrio|asnum }}</td>
          <td class="num">{{ e.RendimientoEstacionalCalor|aspct }}</td>
          <td class="num">{{ e.RendimientoEstacionalFrio|aspct }}</td>
        </tr>
        <tr>
          <td class="title" width="25%">Enfriamiento gratuito</td>
          <td class="title" width="25%">Enfriamiento evaporativo</td>
          <td class="title" width="25%">Recuperación de energía</td>
          <td class="title" width="25%">Control</td>
        </tr>
        <tr>
          <td>{{ e.EnfriamientoGratuito|default:'-' }}</td>
          <td>{{ e.EnfriamientoEvaporativo|default:'-' }}</td>
          <td>{{ e.RecuperacionEnergia|default:'-' }}</td>
          <td>{{ e.TipoControl|default:'-' }}</td>
        </tr>
      </table>
      <br />
      {% endfor %}
    </div>

    <div class="section">
      <h5>Torres de refrigeración (sólo edificios terciarios)</h5>

      <table>
        <tr>
          <td class="title" width="25%">Nombre</td>
          <td class="title" width="25%">Tipo</td>
          <td class="title" width="25%">Servicio asociado</td>
          <td class="title" width="25%">Consumo de energía [kWh/año]</td>
        </tr>
        {% for e in report.data.InstalacionesTermicas.TorresyRefrigeracion|default:' ' %}
        <tr>
          <td>{{ e.Nombre }}</td>
          <td>{{ e.Tipo }}</td>
          <td>{{ e.ServicioAsociado }}</td>
          <td class="num">{{ e.ConsumoDeEnergia|asnum }}</td>
        </tr>
        {% endfor %}
        <tr>
          <td class="total text-center">TOTALES</td>
          <td class="shade"></td>
          <td class="shade"></td>
          <td class="total num calc">{{ report.data.InstalacionesTermicas.totalconsumotorresyrefrigeracion|asnum }}</td>
        </tr>
      </table>
    </div>

    <div class="section">
      <h5>Ventilación y bombeo (sólo edificios terciarios)</h5>

      {% if not report.data.InstalacionesTermicas.VentilacionyBombeo %}
        
      <table><tr><td class="report-warning">No se han definido sistemas de ventilación y bombeo</td></tr></table>
      {% else %}
      <table>
        <tr>
          <td class="title" width="25%">Nombre</td>
          <td class="title" width="25%">Tipo</td>
          <td class="title" width="25%">Servicio asociado</td>
          <td class="title" width="25%">Consumo de energía [kWh/año]</td>
        </tr>
        {% for e in report.data.InstalacionesTermicas.VentilacionyBombeo|default:' ' %}
        <tr>
          <td>{{ e.Nombre }}</td>
          <td>{{ e.Tipo }}</td>
          <td>{{ e.ServicioAsociado }}</td>
          <td class="num">{{ e.ConsumoDeEnergia|asnum }}</td>
        </tr>
        {% endfor %}
        <tr>
          <td class="total text-center">TOTALES</td>
          <td class="shade"></td>
          <td class="shade"></td>
          <td class="total num calc">{{ report.data.InstalacionesTermicas.totalconsumoventilacionybombeo|asnum }}</td>
        </tr>
      </table>
      {% endif %}
    </div>

    <div class="section">
      <h4>4. INSTALACIÓN DE ILUMINACIÓN (sólo edificios terciarios)</h4>

      <table>
        <tr>
          <td class="title" width="30%">Espacio</td>
          <td class="title">Potencia instalada [W/m<sup>2</sup>]</td>
          <td class="title">VEEI [W/m<sup>2</sup>·100lux]</td>
          <td class="title">Iluminancia media [lux]</td>
          <td class="title">Modo de obtención</td>
        </tr>
        {% for e in report.data.InstalacionesIluminacion.Espacios %}
        <tr>
          <td>{{ e.Nombre }}</td>
          <td class="num">{{ e.PotenciaInstalada|asnum }}</td>
          <td class="num">{{ e.VEEI|asnum }}</td>
          <td class="num">{{ e.IluminanciaMedia|asnum }}</td>
          <td>{{ e.ModoDeObtencion }}</td>
        </tr>
        {% endfor %}
        <tr>
          <td class="total text-center">TOTALES</td>
          <td class="total num">{{ report.data.InstalacionesIluminacion.totalpotenciamedia|asnum }}</td>
          <td class="shade"></td>
          <td class="shade"></td>
          <td class="shade"></td>
        </tr>
      </table>
    </div>

    <div class="section">
      <h4>5. CONDICIONES DE FUNCIONAMIENTO Y OCUPACIÓN (sólo edificios terciarios)</h4>

      <table>
        <tr>
          <td class="title" width="33%">Espacio</td>
          <td class="title" width="33%">Superficie [m<sup>2</sup>]</td>
          <td class="title" width="33%">Perfil de uso</td>
        </tr>
        {% for e in report.data.CondicionesFuncionamientoyOcupacion %}
        <tr>
          <td>{{ e.Nombre }}</td>
          <td class="num">{{ e.Superficie|asnum }}</td>
          <td>{{ e.PerfilDeUso }}</td>
        </tr>
        {% endfor %}
      </table>
    </div>

    <div class="section">
      <h4>6. ENERGÍAS RENOVABLES</h4>

      <h5>Térmica</h5>
      <table>
        <tr>
          <td class="title" width="20%" rowspan="2">Nombre</td>
          <td class="title" colspan="3">Consumo de Energía Final cubierto, en función del servicio asociado [%]</td>
          <td class="title" width="20%" align="center" rowspan="2">Demanda de ACS cubierta [%]</td>
        </tr>
        <tr>
          <td class="title" width="20%">Calefacción</td>
          <td class="title" width="20%">Refrigeración</td>
          <td class="title" width="20%">ACS</td>
        </tr>
        {% for e in report.data.EnergiasRenovables.Termica %}
        <tr>
          <td>{{ e.Nombre }}</td>
          <td class="num">{{ e.ConsumoFinalCalefaccion|asnum }}</td>
          <td class="num">{{ e.ConsumoFinalRefrigeracion|asnum }}</td>
          <td class="num">{{ e.ConsumoFinalACS|asnum }}</td>
          <td class="num">{{ e.DemandaACS|asnum }}</td>
        </tr>
        {% endfor %}
        {% with totaltermica=report.data.EnergiasRenovables.totaltermica %}
        <tr>
          <td class="total text-center">TOTAL</td>
          <td class="total num">{{ totaltermica.ConsumoFinalCalefaccion|asnum }}</td>
          <td class="total num">{{ totaltermica.ConsumoFinalRefrigeracion|asnum }}</td>
          <td class="total num">{{ totaltermica.ConsumoFinalACS|asnum }}</td>
          <td class="total num">{{ totaltermica.DemandaACS|asnum }}</td>
        </tr>
        {% endwith %}
      </table>
    </div>

    <div class="section">
      <h5>Eléctrica</h5>

      <table style="width:75%" align="center">
        <tr>
          <td class="title">Nombre</td>
          <td class="title">Energía eléctrica generada y autoconsumida [kWh/año]</td>
        </tr>
        {% for e in report.data.EnergiasRenovables.Electrica|default:' ' %}
        <tr>
          <td>{{ e.Nombre }}</td>
          <td class="num">{{ e.EnergiaGeneradaAutoconsumida|asnum }}</td>
        </tr>
        {% endfor %}
        <tr>
          <td class="total text-center">TOTAL</td>
          <td class="total num">{{ report.data.EnergiasRenovables.totalelectrica|asnum }}</td>
        </tr>
      </table>
    </div>

    <div class="page-break"></div>
    <!-- ANEXO II - Calificación energética -->
    <h3 class="text-center">ANEXO II<br />CALIFICACIÓN ENERGÉTICA DEL EDIFICIO</h3>

    <table>
      <tr>
        <td class="title">Zona Climática</td>
        <td>{{ report.data.IdentificacionEdificio.ZonaClimatica }}</td>
        <td class="title">Uso</td>
        <td width="40%">{{ report.data.IdentificacionEdificio.TipoDeEdificio }}</td>
      </tr>
    </table>

    <div class="section">
      <h4>1. CALIFICACIÓN ENERGÉTICA DEL EDIFICIO EN EMISIONES</h4>

      <table class="no-fixed">
        <tr>
          <td class="title" width="50%">INDICADOR GLOBAL</td>
          <td class="title" width="50%"colspan="4">INDICADORES PARCIALES</td>
        </tr>
        <tr>
          <td rowspan="6" align="center" class="info">
            <img class="escala" src="{% escalasvg report.data.EmisionesCO2.Global report 'EmisionesCO2' %}" />
            <div>Emisiones globales [kgCO<sub>2e</sub>/m<sup>2</sup>·año]</p></div>
          </td>
          <td class="title" colspan="2">CALEFACCIÓN</td>
          <td class="title" colspan="2">ACS</td>
        </tr>
        <tr>
          <td class="info">Emisiones calefacción [kgCO<sub>2e</sub>/m<sup>2</sup>·año]</td>
          <td rowspan="2">{{ report.data.Calificacion.EmisionesCO2.Calefaccion|default:'-' }}</td>
          <td class="info">Emisiones ACS [kgCO<sub>2e</sub>/m<sup>2</sup>·año]</td>
          <td rowspan="2">{{ report.data.Calificacion.EmisionesCO2.ACS|default:'-' }}</td>
        </tr>
        <tr>
          <td class="info">{{ report.data.EmisionesCO2.Calefaccion|asnum }}</td>
          <td class="info">{{ report.data.EmisionesCO2.ACS|asnum }}</td>
        </tr>
        <tr>
          <td class="title" colspan="2">REFRIGERACIÓN</td>
          <td class="title" colspan="2">ILUMINACIÓN</td>
        </tr>
        <tr>
          <td class="info">Emisiones refrigeración [kgCO<sub>2e</sub>/m<sup>2</sup>·año]</td>
          <td rowspan="2">{{ report.data.Calificacion.EmisionesCO2.Refrigeracion|default:'-' }}</td>
          <td class="info">Emisiones iluminación [kgCO<sub>2e</sub>/m<sup>2</sup>·año]</td>
          <td rowspan="2">{{ report.data.Calificacion.EmisionesCO2.Iluminacion|default:'-' }}</td>
        </tr>
        <tr>
          <td class="info">{{ report.data.EmisionesCO2.Refrigeracion|asnum }}</td>
          <td class="info">{{ report.data.EmisionesCO2.Iluminacion|asnum }}</td>
        </tr>
      </table>

      <p>La calificación global del edificio se expresa en términos de dióxido de carbono liberado a la atmósfera como consecuencia del consumo energético del mismo.</p>

      <table style="width:75%" align="center">
        <tr>
          <td></td>
          <td class="title" width="20%">kgCO<sub>2e</sub>/m<sup>2</sup>·año</td>
          <td class="title" width="20%">kgCO<sub>2e</sub>/año</td>
        </tr>
        <tr>
          <td class="info">Emisiones CO<sub>2</sub> por consumo eléctrico</td>
          <td class="num">{{ report.data.EmisionesCO2.ConsumoElectrico|asnum }}</td>
          <td class="num">{{ report.data.EmisionesCO2.TotalConsumoElectrico|asint }}</td>
        <tr>
          <td class="info">Emisiones CO<sub>2</sub> por otros combustibles</td>
          <td class="num">{{ report.data.EmisionesCO2.ConsumoOtros|asnum }}</td>
          <td class="num">{{ report.data.EmisionesCO2.TotalConsumoOtros|asint }}</td>
        </tr>
      </table>
    </div>

    <div class="section">
      <h4>2. CALIFICACIÓN ENERGÉTICA DEL EDIFICIO EN CONSUMO DE ENERGÍA PRIMARIA NO RENOVABLE</h4>

      <p>Por energía primara no renovable se entiende la energía consumida por el edificio procedente de fuentes no renovables que no ha sufrido ningún proceso de conversión o transformación.</p>

      <table class="no-fixed">
        <tr>
          <td class="title" width="50%">INDICADOR GLOBAL</td>
          <td class="title" width="50%" colspan="4">INDICADORES PARCIALES</td>
        </tr>
        <tr>
          <td rowspan="6" align="center" class="info">
            <img class="escala" src="{% escalasvg report.data.Consumo.EnergiaPrimariaNoRenovable.Global report 'EnergiaPrimariaNoRenovable' %}" />
            <div>Consumo global de energía primaria no renovable [kWh/m<sup>2</sup>·año]</div>
          </td>
          <td class="title" colspan="2">CALEFACCIÓN</td>
          <td class="title" colspan="2">ACS</td>
        </tr>
        <tr>
          <td class="info">Energía primaria calefacción [kWh/m<sup>2</sup>·año]</td>
          <td rowspan="2">{{ report.data.Calificacion.EnergiaPrimariaNoRenovable.Calefaccion|default:'-' }}</td>
          <td class="info">Energía primaria ACS [kWh/m<sup>2</sup>·año]</td>
          <td rowspan="2">{{ report.data.Calificacion.EnergiaPrimariaNoRenovable.ACS|default:'-' }}</td>
        </tr>
        <tr>
          <td class="info">{{ report.data.Consumo.EnergiaPrimariaNoRenovable.Calefaccion|asnum }}</td>
          <td class="info">{{ report.data.Consumo.EnergiaPrimariaNoRenovable.ACS|asnum }}</td>
        </tr>
        <tr>
          <td class="title" colspan="2">REFRIGERACIÓN</td>
          <td class="title" colspan="2">ILUMINACIÓN</td>
        </tr>
        <tr>
          <td class="info">Energía primaria refrigeración [kWh/m<sup>2</sup>·año]</td>
          <td rowspan="2">{{ report.data.Calificacion.EnergiaPrimariaNoRenovable.Refrigeracion|default:'-' }}</td>
          <td class="info">Energía primaria iluminación [kWh/m<sup>2</sup>·año]</td>
          <td rowspan="2">{{ report.data.Calificacion.EnergiaPrimariaNoRenovable.Iluminacion|default:'-' }}</td>
        </tr>
        <tr>
          <td class="info">{{ report.data.Consumo.EnergiaPrimariaNoRenovable.Refrigeracion|asnum }}</td>
          <td class="info">{{ report.data.Consumo.EnergiaPrimariaNoRenovable.Iluminacion|asnum }}</td>
        </tr>
      </table>
    </div>

    <div class="section">
      <h4>3. CALIFICACIÓN PARCIAL DE LA DEMANDA ENERGÉTICA DE CALEFACCIÓN Y REFRIGERACIÓN</h4>

      <p>La demanda energética de calefacción y refrigeración es la energía necesaria para mantener las condiciones internas de confort del edificio.</p>

      <div class="row">
        <div class="calif">
          <table>
            <tr>
              <td class="title">DEMANDA DE CALEFACCIÓN</td>
              <td class="title">DEMANDA DE REFRIGERACIÓN</td>
            </tr>
            <tr>
              <!-- XXX: ver aquí los casos de terciario con 08 ren/h -->
              <td><img class="escala" src="{% escalasvg report.data.Demanda.EdificioObjeto.Calefaccion report 'DemandaCalefaccion' %}" /></td>
              <td><img class="escala" src="{% escalasvg report.data.Demanda.EdificioObjeto.Refrigeracion report 'DemandaRefrigeracion' %}" /></td>
            </tr>
            <tr>
              <td class="info">Demanda de calefacción [kWh/m<sup>2</sup>·año]</td>
              <td class="info">Demanda de refrigeración [kWh/m<sup>2</sup>·año]</td>
            </tr>
          </table>
        </div>
      </div>
    </div>

    <div class="page-break"></div>
    <!-- ANEXO III - Medidas de mejora -->
    <h3 class="text-center">ANEXO III<br />RECOMENDACIONES PARA LA MEJORA DE LA EFICIENCIA ENERGÉTICA</h3>
    <form action="{% url 'measures_xml_upload'%}" method="POST" enctype="multipart/form-data" class="measures-form">
      {% csrf_token %}
      <a href="#" class="hidden-print measures-xml-link">
        <span>
          Subir XML con medidas de mejora
        </span>
        <input type="file" class="measures-xml hidden" name="measures-xml"/>
      </a>
    </form>

    {% if not report.data.MedidasDeMejora %}
    <table><tr><td>No se han definido medidas de mejora de la eficiencia energética</td></tr></table>
    {% else %}
    {% for medida in report.data.MedidasDeMejora %}
    <h4>MEDIDA DE MEJORA DE LA EFICIENCIA ENERGÉTICA <a href="#" data-index="{{forloop.counter}}" data-type="measure" class="hidden-print delete-element">(Eliminar medida de mejora)</a></h4>
    <table>
      <tr>
        <td width="20%" class="title">Denominación:</td>
        <td>
          <strong>
            <a href="#" class="editable" id="MedidasDeMejora.Medida[{{ forloop.counter }}].Nombre">
              {{ medida.Nombre }}
            </a>
          </strong>
        </td>
      </tr>
    </table>

    <br />

    <h4 class="text-center">CALIFICACIÓN ENERGÉTICA GLOBAL</h4>
    <div class="row">
      <div class="calif">
        <table>
          <tr>
            <td class="title">CONSUMO DE ENERGÍA PRIMARIA NO RENOVABLE<br />[kWg/m<sup>2</sup>·año]</td>
            <td class="title">EMISIONES DE DIÓXIDO DE CARBONO<br />[kgCO<sub>2e</sub>/m<sup>2</sup>·año]</td>
          </tr>
          <tr>
            <td><img class="escala" src="{% escalasvg medida.EnergiaPrimariaNoRenovable.Global report 'EnergiaPrimariaNoRenovable' %}" /></td>
            <td><img class="escala" src="{% escalasvg medida.EmisionesCO2.Global report 'EmisionesCO2' %}" /></td>
          </tr>
        </table>
      </div>
    </div>
    <br />

    <h4 class="text-center">CALIFICACIONES ENERGÉTICAS PARCIALES</h4>
    <div class="row">
      <div class="calif">
        <table>
          <tr>
            <td class="title">DEMANDA DE CALEFACCIÓN<br />[kWh/m<sup>2</sup>·año]</td>
            <td class="title">DEMANDA DE REFRIGERACIÓN<br />[kgCO<sub>2e</sub>/m<sup>2</sup>·año]</td>
          </tr>
          <tr>
            <td><img class="escala" src="{% escalasvg medida.Demanda.Calefaccion report 'DemandaCalefaccion' %}" /></td>
            <td><img class="escala" src="{% escalasvg medida.Demanda.Refrigeracion report 'DemandaRefrigeracion' %}" /></td>
          </tr>
        </table>
      </div>
    </div>

    <h4>ANÁLISIS TÉCNICO</h4>

    <table>
      <tr>
        <td width="15%" class="title" rowspan="2">Indicador</td>
        <td class="title" colspan="2">Calefacción</td>
        <td class="title" colspan="2">Refrigeración</td>
        <td class="title" colspan="2">ACS</td>
        <td class="title" colspan="2">Iluminación</td>
        <td class="title" colspan="2">Total</td>
      </tr>
      <tr>
        <td class="title">Valor</td>
        <td class="title">Ahorro<br /><small>respecto a la situación original</small></td>
        <td class="title">Valor</td>
        <td class="title">Ahorro<br /><small>respecto a la situación original</small></td>
        <td class="title">Valor</td>
        <td class="title">Ahorro<br /><small>respecto a la situación original</small></td>
        <td class="title">Valor</td>
        <td class="title">Ahorro<br /><small>respecto a la situación original</small></td>
        <td class="title">Valor</td>
        <td class="title">Ahorro<br /><small>respecto a la situación original</small></td>
      </tr>
      <tr>
        <td class="title">Consumo Energía final<br /><small>[kWh/m<sup>2</sup>·año]</small></td>
        <td class="num">{{ medida.EnergiaFinal.Calefaccion|asnum }}</td>
        <td class="num calc small dif">{{ medida.EnergiaFinal.Calefaccion|difwith:report.data.Consumo.EnergiaFinal.Calefaccion|safe }}</td>
        <td class="num">{{ medida.EnergiaFinal.Refrigeracion|asnum }}</td>
        <td class="num calc small dif">{{ medida.EnergiaFinal.Refrigeracion|difwith:report.data.Consumo.EnergiaFinal.Refrigeracion|safe }}</td>
        <td class="num">{{ medida.EnergiaFinal.ACS|asnum }}</td>
        <td class="num calc small dif">{{ medida.EnergiaFinal.ACS|difwith:report.data.Consumo.EnergiaFinal.ACS|safe }}</td>
        <td class="num">{{ medida.EnergiaFinal.Iluminacion|asnum }}</td>
        <td class="num calc small dif">{{ medida.EnergiaFinal.Iluminacion|difwith:report.data.Consumo.EnergiaFinal.Iluminacion|safe }}</td>
        <td class="num">{{ medida.EnergiaFinal.Global|asnum }}</td>
        <td class="num calc small dif">{{ medida.EnergiaFinal.Global|difwith:report.data.Consumo.EnergiaFinal.Global|safe }}</td>
      </tr>
      <tr>
        <td class="title">Consumo Energía primaria no renovable<br /><small>[kWh/m<sup>2</sup>·año]</small></td>
        <td class="num">{{ medida.EnergiaPrimariaNoRenovable.Calefaccion|asnum }}<br />{{ medida.CalificacionEnergiaPrimariaNoRenovable.Calefaccion|default:'-' }}</td>
        <td class="num calc small dif">{{ medida.EnergiaPrimariaNoRenovable.Calefaccion|difwith:report.data.Consumo.EnergiaPrimariaNoRenovable.Calefaccion|safe }}</td>
        <td class="num">{{ medida.EnergiaPrimariaNoRenovable.Refrigeracion|asnum }}<br />{{ medida.CalificacionEnergiaPrimariaNoRenovable.Refrigeracion|default:'-' }}</td>
        <td class="num calc small dif">{{ medida.EnergiaPrimariaNoRenovable.Refrigeracion|difwith:report.data.Consumo.EnergiaPrimariaNoRenovable.Refrigeracion|safe }}</td>
        <td class="num">{{ medida.EnergiaPrimariaNoRenovable.ACS|asnum }}<br />{{ medida.CalificacionEnergiaPrimariaNoRenovable.ACS|default:'-' }}</td>
        <td class="num calc small dif">{{ medida.EnergiaPrimariaNoRenovable.ACS|difwith:report.data.Consumo.EnergiaPrimariaNoRenovable.ACS|safe }}</td>
        <td class="num">{{ medida.EnergiaPrimariaNoRenovable.Iluminacion|asnum }}<br />{{ medida.CalificacionEnergiaPrimariaNoRenovable.Iluminacion|default:'-' }}</td>
        <td class="num calc small dif">{{ medida.EnergiaPrimariaNoRenovable.Iluminacion|difwith:report.data.Consumo.EnergiaPrimariaNoRenovable.Iluminacion|safe }}</td>
        <td class="num">{{ medida.EnergiaPrimariaNoRenovable.Global|asnum }}<br />{{ medida.CalificacionEnergiaPrimariaNoRenovable.Global|default:'-' }}</td>
        <td class="num calc small dif">{{ medida.EnergiaPrimariaNoRenovable.Global|difwith:report.data.Consumo.EnergiaPrimariaNoRenovable.Global|safe }}</td>
      </tr>
      <tr>
        <td class="title">Emisiones de CO<sub>2</sub><br /><small>[kgCO<sub>2e</sub>/m<sup>2</sup>·año]</small></td>
        <td class="num">{{ medida.EmisionesCO2.Calefaccion|asnum }}<br />{{ medida.CalificacionEmisionesCO2.Calefaccion|default:'-' }}</td>
        <td class="num calc small dif">{{ medida.EmisionesCO2.Calefaccion|difwith:report.data.EmisionesCO2.Calefaccion|safe }}</td>
        <td class="num">{{ medida.EmisionesCO2.Refrigeracion|asnum }}<br />{{ medida.CalificacionEmisionesCO2.Refrigeracion|default:'-' }}</td>
        <td class="num calc small dif">{{ medida.EmisionesCO2.Refrigeracion|difwith:report.data.EmisionesCO2.Refrigeracion|safe }}</td>
        <td class="num">{{ medida.EmisionesCO2.ACS|asnum }}<br />{{ medida.CalificacionEmisionesCO2.ACS|default:'-' }}</td>
        <td class="num calc small dif">{{ medida.EmisionesCO2.ACS|difwith:report.data.EmisionesCO2.ACS|safe }}</td>
        <td class="num">{{ medida.EmisionesCO2.Iluminacion|asnum }}<br />{{ medida.CalificacionEmisionesCO2.Iluminacion|default:'-' }}</td>
        <td class="num calc small dif">{{ medida.EmisionesCO2.Iluminacion|difwith:report.data.EmisionesCO2.Iluminacion|safe }}</td>
        <td class="num">{{ medida.EmisionesCO2.Global|asnum }}<br />{{ medida.CalificacionEmisionesCO2.Global|default:'-' }}</td>
        <td class="num calc small dif">{{ medida.EmisionesCO2.Global|difwith:report.data.EmisionesCO2.Global|safe }}</td>
      </tr>
      <tr>
        <td class="title">Demanda<br /><small>[kWh/m<sup>2</sup>·año]</small></td>
        <td class="num">{{ medida.Demanda.Calefaccion|asnum }}<br />{{ medida.CalificacionDemanda.Calefaccion|default:'-' }}</td>
        <td class="num calc small dif">{{ medida.Demanda.Calefaccion|difwith:report.data.Demanda.EdificioObjeto.Calefaccion|safe }}</td>
        <td class="num">{{ medida.Demanda.Refrigeracion|asnum }}<br />{{ medida.CalificacionDemanda.Refrigeracion|default:'-' }}</td>
        <td class="num calc small dif">{{ medida.Demanda.Refrigeracion|difwith:report.data.Demanda.EdificioObjeto.Refrigeracion|safe }}</td>
        <td colspan="2" class="shade">&nbsp;</td>
        <td colspan="2" class="shade">&nbsp;</td>
        <td colspan="2" class="shade">&nbsp;</td>
      </tr>
    </table>

    <p>Nota: Los indicadores energéticos anteriores están calculados en base a coeficientes estándar de operación y funcionamiento del edificio, por lo que solo son válidos a efectos de su calificación energética. Para el análisis económico de las medidas de ahorro y eficiencia energética, el técnico certificador deberá utilizar las condiciones reales y datos históricos de consumo del edificio.</p>

    <br />

    <table>
      <tr><td class="title">DESCRIPCIÓN DE LA MEDIDA DE MEJORA</td></tr>
      <tr>
        <td class="editor-html5">
          <strong>Características técnicas de la medida (modelo de equipos, materiales, parámetros característicos)</strong><br /><br />
          <a href="#" class="editable" data-type="wysihtml5" data-showbuttons="bottom" id="MedidasDeMejora.Medida[{{ forloop.counter }}].Descripcion">{{ medida.Descripcion|safe }}</a>
        </td>
      </tr>
      <tr>
        <td>
          <strong>Coste estimado de la medida</strong><br /><br />
          <a href="#" class="editable"  id="MedidasDeMejora.Medida[{{ forloop.counter }}].CosteEstimado">{{ medida.CosteEstimado|safe }}</a>
        </td>
      <tr/>
      <tr>
        <td class="editor-html5">
          <strong>Otros datos de interés</strong><br /><br />
          <a href="#" class="editable" data-type="wysihtml5" data-showbuttons="bottom" id="MedidasDeMejora.Medida[{{ forloop.counter }}].OtrosDatos">{{ medida.OtrosDatos|safe }}</a>
        </td>
      <tr/>
    </table>
    {% endfor %}
    {% endif %}

    <div class="page-break" ></div>
    <!-- ANEXO IV -->
    <h3 class="text-center" id="anexo-iv">ANEXO IV<br />PRUEBAS, COMPROBACIONES E INSPECCIONES REALIZADAS POR EL TÉCNICO CERTIFICADOR</h3>

    <p>Se describen a continuación las pruebas, comprobaciones e inspecciones llevadas a cabo por el técnico certificador durante el proceso de toma de datos y de calificación de la eficiencia energética del edificio, con la finalidad de establecer la conformidad de la información de partida contenida en el certificado de eficiencia energética.</p>

    <table>
      {% for visita in report.data.PruebasComprobacionesInspecciones %}
      <tr>
        <td width="80%" class="title">Fecha de realización de la visita del técnico certificador</td>
        <td>
          <a href="#" class="editable" id="PruebasComprobacionesInspecciones.Visita[{{ forloop.counter }}].FechaVisita">
            {{ visita.FechaVisita }}    
          </a>


          <a href="#" class="pull-right hidden-print delete-element delete-visit" data-index="{{forloop.counter}}" data-type="visit">Eliminar</a>
        </td>
      </tr>
      <tr>
        <td colspan="2" class="editor-html5">
          <a href="#" class="editable" data-type="wysihtml5" data-showbuttons="bottom" id="PruebasComprobacionesInspecciones.Visita[{{ forloop.counter }}].Datos">{{ visita.Datos|safe }}</a>
        </td>
      </tr>
      {% endfor %}
    </table>


  {% if report.has_annex_v %}
    
    <div class="page-break" ></div>
    <!-- ANEXO V -->
    <h3 class="text-center" id="anexo-v">ANEXO V<br />Justificación de Soluciones Singulares</h3>
    <table>
      <tr><td class="title">
        Descripción
        <a class="pull-right delete-element" data-index="0" data-type="solutions" href="#">Eliminar</a>
      </td></tr>
      <tr><td class="editor-html5">
        <a href="#" class="editable" data-type="wysihtml5" data-showbuttons="bottom" id="DatosPersonalizados.SolucionesSingulares">{{ report.get_annex_v|safe }}</a>
      </td></tr>
    </table>

  {% endif %}

  </div>
  <form id="secret-form" action="{% url 'measures_xml_upload' %}" class="hidden" method="POST" enctype="multipart/form-data">
  {% csrf_token %}
  </form>

  <br>
  <a class="hidden-print pull-right btn btn-primary" href="{% url 'new_visit' %}">Nueva Visita</a> 

  {% if not report.has_annex_v %}
    <a class="hidden-print pull-right btn btn-primary add-singular-solutions" href="{% url 'add_singular_solutions' %}">Añadir Anexo de Justificación de Soluciones Singulares</a> 
  {% endif %}

  <br><br>
  <script>
    var generation_date = '{{ report.data.DatosDelCertificador.Fecha }}';
    var reference = '{{ report.data.IdentificacionEdificio.ReferenciaCatastral }}';
  </script>

</div>

{% endif %}
{% endblock %}

{% block extra_js %}

  <script src="{%  static "js/jquery.formset.js" %}"></script>

  <script>

  {% for a,b,id in validation_data.info %}
    {% if id %}
      $("#{{id}}").closest("td").addClass("report-warning");
    {% endif %}
  {% endfor %}



  Blob.prototype.convertToBase64 = function(callback){
          var FR= new FileReader();
          FR.onload = function(e) {
               callback(e.target.result)
          };       
          FR.readAsDataURL(this);
  }


  $(function() {

    $("body").on("click", ".editable-submit", function(){
      $(this).closest("td").removeClass("report-warning");
      $(this).closest("td").addClass("edited")
    })

    $(".delete-element").on("click", function(e){
      e.preventDefault();
      var data = {
              index: $(this).data("index"),
              type: $(this).data("type"),
              csrfmiddlewaretoken : "{{ csrf_token }}" 
            };

      if(confirm("{% trans "¿Está seguro de que desea eliminar este elemento?" %}")){
        $.ajax({
            url: '{% url 'delete_element' %}',
            type: 'POST',
            data: data,
          }).done(function(){
              //Reload page
              window.location.href = "{% url 'certificate'%}";
          }).fail(function(){
            console.log("An error occurred, the measure couldn't be deleted!");
          });
      }

      return false;
    });

    $(".measures-xml-link").on("click", function(e){
      event.preventDefault();
      var fileSelector = $('<input type="file" name="measures-xml" />')
        .change(function() {
          $("#secret-form").submit()
        })
      $("#secret-form").append(fileSelector);
      fileSelector.click();
    });


    var fileInputOptions = {
          'showUpload': false,
          'showPreview': false,
          'showRemove': false,
          'browseClass': 'btn btn-default'
        }
    $("#formset").formset({
      animateForms: true
    })
    .on('formAdded', function(event) {
        var newForm = $(event.target);
        newForm.find('input:file').fileinput(fileInputOptions);
    });

    $("input.file-input").fileinput(fileInputOptions);


    $.fn.editable.defaults.mode = 'inline';
    $('.editable').editable({
      url: '{% url "update-xml" %}',
      pk: 1
    });


    $('.upload-image').click(function(event) {
      event.preventDefault();

      var section = $(this).data('section');

      var fileSelector = $('<input type="file" />')
        .change(function() {
          var file = this.files[0];
          var form = new FormData();
          form.append('image', file);
          form.append('section', section);

          $.ajax({
            url: '{% url 'upload-image' %}',
            type: 'POST',
            data: form,
            processData: false,
            contentType: false
          }).done(function(){
            var location = window.location.href.split("/");
            location = "/" + location[location.length-1];
            if( location ==  "{% url 'certificate'%}#anexo-I")
              window.location.reload();
            else
              window.location.href = "{% url 'certificate'%}#anexo-I";
          }).fail(function(){
            console.log("An error occurred, the files couldn't be sent!");
          });
        })
      fileSelector.click();

    });

    $(".editor-html5 > a").on("click", function(e){
      debugger;
      setTimeout(function(){
        $(".wysihtml5-toolbar li:nth-child(5) a.btn").on("click", function(event){
          event.preventDefault();
          debugger;
          var editor = $(this).closest(".editable-input").find("textarea").data("wysihtml5").editor;

          var fileSelector = $('<input type="file" />')
            .change(function() {
              var file = this.files[0],
              name = file.name,
              date = file.lastModifiedDate;
              ImageTools.resize(file, {
                width: 450,
                height: 400,
              },function(blob, didItResize){
                console.log(name);
                console.log(date);
                blob.name = name;
                blob.lastModifiedDate = date;
                blob.convertToBase64(function(base64){
                  editor.composer.commands.exec("insertImage", base64);
                });
              })
            })
          fileSelector.click();
        })
      }, 800);

    });
  });
  </script>
{% endblock %}


