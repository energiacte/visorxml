{% extends "base.html" %}
{% load staticfiles %}
{% load i18n %}
{% load visorxml %}
{% load formset_tags %}

{% block title %}{% trans "Visor de informes" %}{% endblock %}

{% block content %}
{% get_uso %} {#  es_vivienda <= [True o False] #}

{% if not pdf %}
<div class="page">
  
  {% if not validated %}
  <hr>
  <p class="lead">
    {% blocktrans %}
    Seleccione un archivo de informe de eficiencia energética en XML 
    {% endblocktrans %}
  </p>

  <p>
    {% static "docs/EjemploTerciario.xml" as xml_example_1_url %}
    {% static "docs/EjemploResidencial.xml" as xml_example_2_url %}
    {% blocktrans %}
    Puede probar la validación con un <a href="{{ xml_example_1_url }}">informe de ejemplo de edificio con uso
    terciario</a> o con un <a href="{{ xml_example_2_url }}">informe de ejemplo de edificio con uso residencial</a>.
    {% endblocktrans %}
  </p>
  {% endif %}

  <div class="row"><div class="col-md-12">
    <br>
    <form action="{% url "validator" %}" class="form" method="POST" enctype="multipart/form-data" id="xml-form">
      {% csrf_token %}
      <div class="hidden">
        <input id="certificate-file" name="certificate-file" type="file"  /><br>
      </div>
      <button class="btn btn-primary xml-select">
        {% if validated %}
          {% trans "Subir otro fichero base XML o PDF+XML" %}
          {% else %}
          {% trans "Añadir Informe base de evaluación energética en formato XML o PDF+XML" %}
        {% endif %}
      </button>
      {% if validated %}
        <a href="/certificate" class="btn btn-warning">Volver a validar</a>
      {% endif %}
    </form>
  </div></div>
<hr>
{% endif %}
<div class="row hidden-print">
  <div class="col-md-12">
        {% if validation_data %}
          {% if validation_data.extra_files_errors %}
            <div class="alert alert-warning">
              <h2>{% trans "Archivos de mejora" %}</h2>
              <p>
                {% blocktrans with extra_files_errors_count=validation_data.extra_files_errors|length %}
                Se han encontrado <strong>{{ extra_files_errors_count }}</strong> errores al tratar los
                archivos de mejora:
                {% endblocktrans %}
              </p>
              <ul>
                {% for filename, errors in validation_data.extra_files_errors.items %}
                  <li>
                    <strong>{{ filename }}</strong>:
                    <ul>
                    {% for error in errors %}
                      <li>{{ error }}</li>
                    {% endfor %}
                    </ul>
                  </li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}


          {% if validation_data.validation_errors %}
            <div class="alert alert-danger">
              <h2>{% trans "Errores de validación" %}</h2>
              <p>
                {% blocktrans with validation_errors_count=validation_data.validation_errors|length %}
                Se han encontrado <strong>{{ validation_errors_count }}</strong> errores de validación:
                {% endblocktrans %}
              </p>
              <ul>
                {% for error in validation_data.validation_errors %}
                  <li>
                    {% if error.0 %}
                      <strong>Línea {{ error.0 }}:</strong>
                    {% endif %}
                    {{ error.1|safe }}
                  </li>
                {% endfor %}
              </ul>
            </div>
          {% else %}
            <div class="alert alert-success">
              <p>{% trans "El informe activo no contiene errores de validación." %}</p>
              {# <p>Puede <a href="{{ url_for('visor')}}" class="alert-link">ver su contenido</a> o seleccionar un nuevo informe para su validación.</p>#}
            </div>
          {% endif %}

          {% if validation_data.info %}
            <div class="alert alert-warning validation">
              <h3>{% trans "Avisos de validación" %}</h3>
              <p>
                {% blocktrans with validation_warnings_count=validation_data.info|length %}
                Se han encontrado <strong>{{ validation_warnings_count }}</strong> avisos de validación:
                {% endblocktrans %}
              </p>
              <ul>
                {% for messagetype, message, id in validation_data.info %}
                  <li><strong>{{ messagetype }}:</strong> {{ message }} </li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}

        {% else %}
          <div class="alert alert-warning">
            <p>{% trans "No existe un informe activo." %}</p>
          </div>
        {% endif %}
      </div>
</div>
</div>
{% if validated %}
<div class="page">
  <div class="informe" id="informe">
    <h2 class="text-center">{% trans "CERTIFICADO DE EFICIENCIA ENERGÉTICA DE EDIFICIOS" %}</h2>

    <div class="section">
      <h4>{% trans "IDENTIFICACIÓN DEL EDIFICIO O DE LA PARTE QUE SE CERTIFICA:" %}</h4>

      <table class="top">
        <tr>
          <td class="title" width="30%">{% trans "Nombre del Edificio" %}</td>
          <td colspan="3">
            <a href="#" class="editable" id="IdentificacionEdificio.NombreDelEdificio">
              {{ report.data.IdentificacionEdificio.NombreDelEdificio }}
            </a>
          </td>
        </tr>
        <tr>
          <td class="title">{% trans "Dirección" %}</td>
          <td colspan="3">
            <a href="#" class="editable" id="IdentificacionEdificio.Direccion">
              {{ report.data.IdentificacionEdificio.Direccion }}
            </a>
          </td>
        </tr>
        <tr>
          <td class="title">{% trans "Municipio" %}</td>
          <td>
            <a href="#" class="editable" id="IdentificacionEdificio.Municipio">
              {{ report.data.IdentificacionEdificio.Municipio }}
            </a>
          </td>
          <td class="title" width="15%">{% trans "Código Postal" %}</td>
          <td>
            <a href="#" class="editable" id="IdentificacionEdificio.CodigoPostal">
              {{ report.data.IdentificacionEdificio.CodigoPostal }}
            </a>
          </td>
        </tr>
        <tr>
          <td class="title">{% trans "Provincia" %}</td>
          <td>
            <a href="#" class="editable" id="IdentificacionEdificio.Provincia">
              {{ report.data.IdentificacionEdificio.Provincia }}
            </a>
          </td>
          <td class="title" width="15%">{% trans "Comunidad Autónoma" %}</td>
          <td>
            <a href="#" class="editable" id="IdentificacionEdificio.ComunidadAutonoma">
              {{ report.data.IdentificacionEdificio.ComunidadAutonoma }}
            </a>
          </td>
        </tr>
        <tr>
          <td class="title">{% trans "Zona climática" %}</td>
          <td>
            <a href="#" class="editable" id="IdentificacionEdificio.ZonaClimatica">
              {{ report.data.IdentificacionEdificio.ZonaClimatica }}
            </a>
          </td>
          <td class="title" width="15%">{% trans "Año construcción" %}</td>
          <td>
            <a href="#" class="editable" id="IdentificacionEdificio.AnoConstruccion">
              {{ report.data.IdentificacionEdificio.AnoConstruccion }}
            </a>
          </td>
        </tr>
        <tr>
          <td class="title">{% trans "Plantas sobre rasante" %}</td>
          <td>
            <a href="#" class="editable" id="DatosGeneralesyGeometria.NumeroDePlantasSobreRasante">
              {{ report.data.DatosGeneralesyGeometria.NumeroDePlantasSobreRasante }}
            </a>
          </td>
          <td class="title" width="15%">{% trans "Plantas bajo rasante" %}</td>
          <td>
            <a href="#" class="editable" id="DatosGeneralesyGeometria.NumeroDePlantasBajoRasante">
              {{ report.data.DatosGeneralesyGeometria.NumeroDePlantasBajoRasante }}
            </a>
          </td>
        </tr>
        <tr>
          <td class="title">{% trans "Normativa vigente (construcción / rehabilitación)" %}</td>
          <td colspan="3">
            <a href="#" class="editable" id="IdentificacionEdificio.NormativaVigente">
              {{ report.data.IdentificacionEdificio.NormativaVigente }}
            </a>
          </td>
        </tr>
        <tr>
          <td class="title">{% trans "Referencia/s catastral/es" %}</td>
          <td colspan="3">
            <a href="#" class="editable" id="IdentificacionEdificio.ReferenciaCatastral">
              {{ report.data.IdentificacionEdificio.ReferenciaCatastral }}
            </a>
          </td>
        </tr>
      </table>

      <br />

      <table>
        <tr><td class="title" colspan="2">{% trans "Tipo de edificio o parte del edificio que se certifica:" %}</td></tr>
        <tr>
          <td width="50%">
            <span style="margin-left:20px" />
            {% if 'Nuevo' in report.data.IdentificacionEdificio.AlcanceInformacionXML %}
              <span class="glyphicon glyphicon-bordered glyphicon-remove" aria-hidden="true"></span>
            {% else %}
              <span class="glyphicon glyphicon-bordered glyphicon-empty" aria-hidden="true"></span>
            {% endif %} {% trans "Edificio de nueva construcción" %}
          </td>
          <td><span style="margin-left:20px" />
            {% if 'Existente' in report.data.IdentificacionEdificio.AlcanceInformacionXML %}
              <span class="glyphicon glyphicon-bordered glyphicon-remove" aria-hidden="true"></span>
            {% else %}
              <span class="glyphicon glyphicon-bordered glyphicon-empty" aria-hidden="true"></span>
            {% endif %} {% trans "Edificio existente" %}</td>
        </tr>
        <tr><td class="title" colspan="2">&nbsp;</td></tr>
        <tr>
          <td>
            <span style="margin-left:20px" />
            {% if 'Vivienda' in report.data.IdentificacionEdificio.TipoDeEdificio %}
              <span class="glyphicon glyphicon-bordered glyphicon-remove" aria-hidden="true"></span>
            {% else %}
              <span class="glyphicon glyphicon-bordered glyphicon-empty" aria-hidden="true"></span>
            {% endif %} {% trans "Vivienda" %}<br />
            <span style="margin-left:40px" />
            {% if 'Unifamiliar' in report.data.IdentificacionEdificio.TipoDeEdificio %}
              <span class="glyphicon glyphicon-bordered glyphicon-remove" aria-hidden="true"></span>
            {% else %}
              <span class="glyphicon glyphicon-bordered glyphicon-empty" aria-hidden="true"></span>
            {% endif %} {% trans "Unifamiliar" %}<br />
            <span style="margin-left:40px" />
            {% if 'Bloque' in report.data.IdentificacionEdificio.TipoDeEdificio %}
              <span class="glyphicon glyphicon-bordered glyphicon-remove" aria-hidden="true"></span>
            {% else %}
              <span class="glyphicon glyphicon-bordered glyphicon-empty" aria-hidden="true"></span>
            {% endif %} {% trans "Bloque" %}<br />
            <span style="margin-left:60px" />
            {% if 'Completo' in report.data.IdentificacionEdificio.TipoDeEdificio %}
              <span class="glyphicon glyphicon-bordered glyphicon-remove" aria-hidden="true"></span>
            {% else %}
              <span class="glyphicon glyphicon-bordered glyphicon-empty" aria-hidden="true"></span>
            {% endif %} {% trans "Bloque Completo" %}<br />
            <span style="margin-left:60px" />
            {% if 'EnBloque' in report.data.IdentificacionEdificio.TipoDeEdificio %}
              <span class="glyphicon glyphicon-bordered glyphicon-remove" aria-hidden="true"></span>
            {% else %}
              <span class="glyphicon glyphicon-bordered glyphicon-empty" aria-hidden="true"></span>
            {% endif %} {% trans "Vivienda individual" %}
          </td>
          <td>
            <span style="margin-left:20px" />
            {% if 'Terciario' in report.data.IdentificacionEdificio.TipoDeEdificio %}
              <span class="glyphicon glyphicon-bordered glyphicon-remove" aria-hidden="true"></span>
            {% else %}
              <span class="glyphicon glyphicon-bordered glyphicon-empty" aria-hidden="true"></span>
            {% endif %} {% trans "Terciario" %}<br />
            <span style="margin-left:40px" />
            {% if 'EdificioUsoTerciario' in report.data.IdentificacionEdificio.TipoDeEdificio %}
              <span class="glyphicon glyphicon-bordered glyphicon-remove" aria-hidden="true"></span>
            {% else %}
              <span class="glyphicon glyphicon-bordered glyphicon-empty" aria-hidden="true"></span>
            {% endif %} {% trans "Edificio completo" %}<br />
            <span style="margin-left:40px" />
            {% if 'Local' in report.data.IdentificacionEdificio.TipoDeEdificio %}
              <span class="glyphicon glyphicon-bordered glyphicon-remove" aria-hidden="true"></span>
            {% else %}
              <span class="glyphicon glyphicon-bordered glyphicon-empty" aria-hidden="true"></span>
            {% endif %} {% trans "Local" %}
          </td>
        </tr>
      </table>
    </div>

    <br />

    <div class="section">
      <h4>{% trans "DATOS DEL TÉCNICO CERTIFICADOR:" %}</h4>

      <table class="top">
        <tr>
          <td class="title" width="30%">{% trans "Nombre y Apellidos" %}</td>
          <td>
            <a href="#" class="editable" id="DatosDelCertificador.NombreyApellidos">
              {{ report.data.DatosDelCertificador.NombreyApellidos }}
            </a>
          </td>
          <td class="title" width="17%">{% trans "NIF/NIE" %}</td>
          <td>
            <a href="#" class="editable" id="DatosDelCertificador.NIF">
              {{ report.data.DatosDelCertificador.NIF }}
            </a>
          </td>
        </tr>
        <tr>
          <td class="title">{% trans "Razón Social" %}</td>
          <td>
            <a href="#" class="editable" id="DatosDelCertificador.RazonSocial">
              {{ report.data.DatosDelCertificador.RazonSocial }}
            </a>
          </td>
          <td class="title">{% trans "NIF" %}</td>
          <td>
            <a href="#" class="editable" id="DatosDelCertificador.NIFEntidad">
              {{ report.data.DatosDelCertificador.NIFEntidad }}
            </a>
          </td>
        </tr>
        <tr>
          <td class="title">{% trans "Domicilio" %}</td>
          <td colspan="3">
            <a href="#" class="editable" id="DatosDelCertificador.Domicilio">
              {{ report.data.DatosDelCertificador.Domicilio }}
            </a>
          </td>
        </tr>
        <tr>
          <td class="title">{% trans "Municipio" %}</td>
          <td>
            <a href="#" class="editable" id="DatosDelCertificador.Municipio">
              {{ report.data.DatosDelCertificador.Municipio }}
            </a>
          </td>
          <td class="title">{% trans "Código Postal" %}</td>
          <td>
            <a href="#" class="editable" id="DatosDelCertificador.CodigoPostal">
              {{ report.data.DatosDelCertificador.CodigoPostal }}
            </a>
          </td>
        </tr>
        <tr>
          <td class="title">{% trans "Provincia" %}</td>
          <td>
            <a href="#" class="editable" id="DatosDelCertificador.Provincia">
              {{ report.data.DatosDelCertificador.Provincia }}
            </a>
          </td>
          <td class="title">{% trans "Comunidad Autónoma" %}</td>
          <td>
            <a href="#" class="editable" id="DatosDelCertificador.ComunidadAutonoma">
              {{ report.data.DatosDelCertificador.ComunidadAutonoma }}
            </a>
          </td>
        </tr>
        <tr>
          <td class="title">{% trans "e-mail" %}</td>
          <td>
            <a href="#" class="editable" id="DatosDelCertificador.Email">
              {{ report.data.DatosDelCertificador.Email }}
            </a>
          </td>
          <td class="title">{% trans "Teléfono" %}</td>
          <td>
            <a href="#" class="editable" id="DatosDelCertificador.Telefono">
              {{ report.data.DatosDelCertificador.Telefono }}
            </a>
          </td>
        </tr>
        <tr>
          <td class="title">{% trans "Titulación habilitante según normativa vigente" %}</td>
          <td colspan="3">
            <a href="#" class="editable" id="DatosDelCertificador.Titulacion">
              {{ report.data.DatosDelCertificador.Titulacion }}
            </a>
          </td>
        </tr>
        <tr>
          <td class="title" colspan="2">{% trans "Procedimiento reconocido de calificación energética utilizado y versión:" %}</td>
          <td colspan="2" class="procedimiento">
            <a href="#" class="editable" id="DatosDelCertificador.Procedimiento">
              {{ report.data.IdentificacionEdificio.Procedimiento }}
            </a>
          </td>
        </tr>
      </table>
    </div>

    <br />

    <div class="section">
      <h4>{% trans "CALIFICACIÓN ENERGÉTICA OBTENIDA:" %}</h4>

      <div class="calif">
        <table>
          <tr>
            <td class="title">{% trans "CONSUMO DE ENERGÍA PRIMARIA NO RENOVABLE" %}<br />[{% trans "kWh/m<sup>2</sup>·año" %}]</td>
            <td class="title">{% trans "EMISIONES DE DIÓXIDO DE CARBONO" %}<br />[{% trans "kgCO<sub>2e</sub>/m<sup>2</sup>·año" %}]</td>
          </tr>
          <tr>
            <td>{% if report.data.Consumo.EnergiaPrimariaNoRenovable.Global %}<img class="escala" src="{% escalasvg report.data.Consumo.EnergiaPrimariaNoRenovable.Global report 'EnergiaPrimariaNoRenovable' %}" />{% endif %}</td>
            <td>{% if report.data.EmisionesCO2.Global %}<img class="escala" src="{% escalasvg report.data.EmisionesCO2.Global report 'EmisionesCO2' %}" />{% endif %}</td>
          </tr>
        </table>
      </div>

      <p>
        {% blocktrans %}
        El técnico certificador abajo firmante certifica que ha realizado la calificación energética del edificio o de la parte que se certifica
        de acuerdo con el procedimiento establecido por la normativa vigente y que son ciertos los datos que figuran en el presente
        documento, y sus anexos:
        {% endblocktrans %}
      </p>

      <p>{% trans "Fecha:" %} {{ report.data.DatosDelCertificador.Fecha }}</p>
      <br />
      <p class="text-center">{% trans "Firma del técnico certificador:" %} {{ report.data.DatosDelCertificador.NombreyApellidos}} - {{ report.data.DatosDelCertificador.NIF}}</p>

      <ol>
        <li><strong>{% trans "Anexo I." %}</strong> {% trans "Descripción de las características energéticas del edificio." %}</li>
        <li><strong>{% trans "Anexo II." %}</strong> {% trans "Calificación energética del edificio." %}</li>
        <li><strong>{% trans "Anexo III." %}</strong> {% trans "Recomendaciones para la mejora de la eficiencia energética." %}</li>
        <li><strong>{% trans "Anexo IV." %}</strong> {% trans "Pruebas, comprobaciones e inspecciones realizadas por el técnico certificador." %}</li>
      </ol>

      <p>{% trans "Registro del Órgano Territorial Competente:" %}</p>
    </div>
    <!-- Falta tabla de pie de página (ver modelo )-->

    <div class="page-break"></div>
    <!-- ANEXO I - Descripción del edificio -->
    <h3 class="text-center" id="anexo-I">{% trans "ANEXO I" %}<br />{% trans "DESCRIPCIÓN DE LAS CARACTERÍSTICAS ENERGÉTICAS DEL EDIFICIO" %}</h3>

    <p>
      {% blocktrans %}
      En este apartado se describen las características energéticas del edificio, envolvente térmica, instalaciones,
      condiciones de funcionamiento y ocupación y demás datos utilizados para obtener la calificación energética del edificio.
      {% endblocktrans %}
    </p>

    <h4>{% trans "1. SUPERFICIE, IMAGEN Y SITUACIÓN" %}</h4>

    <table>
      <tr>
        <td class="title col-md-5">{% trans "Superficie habitable" %} [{% trans "m<sup>2</sup>" %}]</td>
        <td class="col-md-7">{{ report.data.DatosGeneralesyGeometria.SuperficieHabitable|asnum }}</td>
      </tr>
    </table>

    <br />

    <table class="fotos">
      <tr>
        <td class="title col-md-6">{% trans "Imagen del Edificio" %}</td>
        <td class="title col-md-6">{% trans "Plano de situación" %}</td>
      </tr>
      <tr>
        <td class="col-md-6" align="center">
          {% if pdf %}
            <img src="{{ report.data.DatosGeneralesyGeometria.Imagen }}" alt="">
          {% else %}
          <a href="#" class="upload-image" data-section="Imagen" id="DatosGeneralesyGeometria.Imagen"
            {% if report.data.DatosGeneralesyGeometria.Imagen %}
               style=" background-image: url('{{ report.data.DatosGeneralesyGeometria.Imagen }}'); "
            {% else %}
                style=" background-image: url('{% static 'img/sinimagen.svg' %}'); "
            {% endif %}
            >
            <div><img src="{% static 'img/edit.png'%}" alt=""/></div>
          </a>
          {% endif %}
        </td>

        <td class="col-md-6" align="center">
          {% if pdf %}
            <img src="{{ report.data.DatosGeneralesyGeometria.Plano }}" alt="">
          {% else %}
          <a href="#" class="upload-image" data-section="Plano" id="DatosGeneralesyGeometria.Plano"
            {% if report.data.DatosGeneralesyGeometria.Plano %}
                style=" background-image: url('{{ report.data.DatosGeneralesyGeometria.Plano }}'); "
            {% else %}
                style=" background-image: url('{% static 'img/sinimagen.svg' %}'); "
            {% endif %}
            >
            <div><img src="{% static 'img/edit.png'%}" alt=""/></div>
          </a>
          {% endif %}
        </td>
      </tr>
    </table>

    <div class="section">
      <h4>{% trans "2. ENVOLVENTE TÉRMICA" %}</h4>

      <h5>{% trans "Cerramientos opacos" %}</h5>

      <table class="table-hover">
        <tr>
          <td width="30%" class="title">{% trans "Nombre" %}</td>
          <td width="10%" class="title">{% trans "Tipo" %}</td>
          <td width="17%" class="title">{% trans "Superficie" %} [{% trans "m<sup>2</sup>" %}]</td>
          <td class="title">{% trans "Transmitancia" %} [{% trans "W/m<sup>2</sup>·K" %}]</td>
          <td width="20%" class="title">{% trans "Modo de obtención" %}</td>
        </tr>
        {% for e in report.data.DatosEnvolventeTermica.CerramientosOpacos %}
        <tr>
          <td>{{ e.Nombre }}</td>
          <td>{{ e.Tipo }}</td>
          <td class="num">{{ e.Superficie|asnum}}</td>
          <td class="num">{{ e.Transmitancia|asnum }}</td>
          <td>{{ e.ModoDeObtencion }}</td>
        </tr>
        {% endfor %}
      </table>
    </div>

    <div class="section">
      <h5>{% trans "Huecos y lucernarios" %}</h5>

      <table>
        <tr>
          <td width="30%" class="title">{% trans "Nombre" %}</td>
          <td width="8%" class="title">{% trans "Tipo" %}</td>
          <td width="12%" class="title">{% trans "Superficie" %} [{% trans "m<sup>2</sup>" %}]</td>
          <td class="title">{% trans "Transmitancia" %} [{% trans "W/m<sup>2</sup>·K" %}]</td>
          <td width="8%" class="title">{% trans "Factor solar" %}</td>
          <td width="14%" class="title">{% trans "Modo de obtención." %}<br />{% trans "Transmitancia" %}</td>
          <td width="14%" class="title">{% trans "Modo de obtención." %}<br />{% trans "Factor solar" %}</td>
        </tr>
        <tr>
          {% for e in report.data.DatosEnvolventeTermica.HuecosyLucernarios %}
        <tr>
          <td>{{ e.Nombre }}</td>
          <td>{{ e.Tipo }}</td>
          <td class="num">{{ e.Superficie|asnum }}</td>
          <td class="num">{{ e.Transmitancia|asnum }}</td>
          <td class="num">{{ e.FactorSolar|asnum }}</td>
          <td>{{ e.ModoDeObtencionTransmitancia }}</td>
          <td>{{ e.ModoDeObtencionFactorSolar }}</td>
        </tr>
        {% endfor %}
        </tr>
      </table>
    </div>

    <div class="section">
      <h4>{% trans "3. INSTALACIONES TÉRMICAS" %}</h4>

      <h5>{% trans "Generadores de calefacción" %}</h5>

      <table>
        <tr>
          <td width="23%" class="title">{% trans "Nombre" %}</td>
          <td width="20%" class="title">{% trans "Tipo" %}</td>
          <td class="title">{% trans "Potencia nominal" %} [kW]</td>
          <td class="title">{% trans "Rendimiento estacional" %} [%]</td>
          <td width="20%" class="title">{% trans "Tipo de energía" %}</td>
          <td width="12%" class="title">{% trans "Modo de obtención" %}</td>
        </tr>
        {% for e in report.data.InstalacionesTermicas.GeneradoresDeCalefaccion %}
        <tr>
          <td>{{ e.Nombre }}</td>
          <td>{{ e.Tipo }}</td>
          <td class="num">{{ e.PotenciaNominal|asnum }}</td>
          <td class="num">{{ e.RendimientoEstacional|aspct }}</td>
          <td>{{ e.VectorEnergetico }}</td>
          <td>{{ e.ModoDeObtencion }}</td>
        </tr>
        {% endfor %}
        <tr>
          <td class="total text-center">{% trans "TOTALES" %}</td>
          <td class="shade"></td>
          <td class="total num calc">{{ report.data.InstalacionesTermicas.totalpotenciageneradoresdecalefaccion|asnum }}</td>
          <td class="shade"></td>
          <td class="shade"></td>
          <td class="shade"></td>
        </tr>
      </table>
    </div>

    <div class="section">
      <h5>{% trans "Generadores de refrigeración" %}</h5>

      <table>
        <tr>
          <td width="23%" class="title">{% trans "Nombre" %}</td>
          <td width="20%" class="title">{% trans "Tipo" %}</td>
          <td class="title">{% trans "Potencia nominal" %} [kW]</td>
          <td class="title">{% trans "Rendimiento estacional" %} [%]</td>
          <td width="20%" class="title">{% trans "Tipo de energía" %}</td>
          <td width="12%" class="title">{% trans "Modo de obtención" %}</td>
        </tr>
        {% for e in report.data.InstalacionesTermicas.GeneradoresDeRefrigeracion %}
        <tr>
          <td>{{ e.Nombre }}</td>
          <td>{{ e.Tipo }}</td>
          <td class="num">{{ e.PotenciaNominal|asnum }}</td>
          <td class="num">{{ e.RendimientoEstacional|aspct }}</td>
          <td>{{ e.VectorEnergetico }}</td>
          <td>{{ e.ModoDeObtencion }}</td>
        </tr>
        {% endfor %}
        <tr>
          <td class="total text-center">{% trans "TOTALES" %}</td>
          <td class="shade"></td>
          <td class="total num calc">{{ report.data.InstalacionesTermicas.totalpotenciageneradoresderefrigeracion|asnum }}</td>
          <td class="shade"></td>
          <td class="shade"></td>
          <td class="shade"></td>
        </tr>
      </table>
    </div>

    <div class="section">
      <h5>{% trans "Instalaciones de Agua Caliente Sanitaria" %}</h5>

      <table style="width:65%">
        <tr>
          <td width="45%" class="title">{% trans "Demanda diaria de ACS a 60ºC (litros/dia)" %}</td>
          <td width="20%" class="num">{{ report.data.DatosGeneralesyGeometria.DemandaDiariaACS|asnum }}</td>
        </tr>
      </table>

      <br />

      <table>
        <tr>
          <td width="23%" class="title">{% trans "Nombre" %}</td>
          <td width="20%" class="title">{% trans "Tipo" %}</td>
          <td class="title">{% trans "Potencia nominal" %} [kW]</td>
          <td class="title">{% trans "Rendimiento estacional" %} [%]</td>
          <td width="20%" class="title">{% trans "Tipo de energía" %}</td>
          <td width="12%" class="title">{% trans "Modo de obtención" %}</td>
        </tr>
        {% for e in report.data.InstalacionesTermicas.InstalacionesACS %}
        <tr>
          <td>{{ e.Nombre }}</td>
          <td>{{ e.Tipo }}</td>
          <td class="num">{{ e.PotenciaNominal|asnum }}</td>
          <td class="num">{{ e.RendimientoEstacional|aspct }}</td>
          <td>{{ e.VectorEnergetico }}</td>
          <td>{{ e.ModoDeObtencion }}</td>
        </tr>
        {% endfor %}
      </table>
    </div>

    <div class="section solo-terciario">
      <h5>{% trans "Sistemas secundarios de calefacción y/o refrigeración (sólo edificios terciarios)" %}</h5>
      {% if not  report.data.InstalacionesTermicas.SistemasSecundariosCalefaccionRefrigeracion and not es_vivienda %}
        <table>
          <tr>
            <td class="report-warning">
              {% trans "No se han definido sistemas secundarios de calefacción y/o refrigeración" %}
            </td>
          </tr>
        </table>
      {% endif %}

      {% for e in report.data.InstalacionesTermicas.SistemasSecundariosCalefaccionRefrigeracion|default:' ' %}
      <table>
        <tr>
          <td class="title" width="25%">{% trans "Nombre" %}</td>
          <td colspan="3">{{ e.Nombre|default:'-' }}</td>
        </tr>
        <tr>
          <td class="title" width="25%">{% trans "Tipo" %}</td>
          <td colspan="3">{{ e.Tipo }}</td>
        </tr>
        <tr>
          <td class="title" width="25%">{% trans "Zona asociada" %}</td>
          <td colspan="3">{{ e.ZonaAsociada }}</td>
        </tr>
        <tr>
          <td class="title" width="25%">{% trans "Potencia calor" %} [kW]</td>
          <td class="title" width="25%">{% trans "Potencia frío" %} [kW]</td>
          <td class="title" width="25%">{% trans "Rendimiento estacional calor" %} [%]</td>
          <td class="title" width="25%">{% trans "Rendimiento estacional frío" %} [%]</td>
        </tr>
        <tr>
          <td class="num">{{ e.PotenciaCalor|asnum }}</td>
          <td class="num">{{ e.PotenciaFrio|asnum }}</td>
          <td class="num">{{ e.RendimientoEstacionalCalor|aspct }}</td>
          <td class="num">{{ e.RendimientoEstacionalFrio|aspct }}</td>
        </tr>
        <tr>
          <td class="title" width="25%">{% trans "Enfriamiento gratuito" %}</td>
          <td class="title" width="25%">{% trans "Enfriamiento evaporativo" %}</td>
          <td class="title" width="25%">{% trans "Recuperación de energía" %}</td>
          <td class="title" width="25%">{% trans "Control" %}</td>
        </tr>
        <tr>
          <td>{{ e.EnfriamientoGratuito|default:'-' }}</td>
          <td>{{ e.EnfriamientoEvaporativo|default:'-' }}</td>
          <td>{{ e.RecuperacionEnergia|default:'-' }}</td>
          <td>{{ e.TipoControl|default:'-' }}</td>
        </tr>
      </table>
      <br />
      {% endfor %}
    </div>

    <div class="section solo-terciario">
      <h5>{% trans "Torres de refrigeración (sólo edificios terciarios)" %}</h5>

      <table>
        <tr>
          <td class="title" width="25%">{% trans "Nombre" %}</td>
          <td class="title" width="25%">{% trans "Tipo" %}</td>
          <td class="title" width="25%">{% trans "Servicio asociado" %}</td>
          <td class="title" width="25%">{% trans "Consumo de energía" %} [{% trans "kWh/año" %}]</td>
        </tr>
        {% for e in report.data.InstalacionesTermicas.TorresyRefrigeracion|default:' ' %}
        <tr>
          <td>{{ e.Nombre|default:'-' }}</td>
          <td>{{ e.Tipo }}</td>
          <td>{{ e.ServicioAsociado }}</td>
          <td class="num">{{ e.ConsumoDeEnergia|asnum }}</td>
        </tr>
        {% endfor %}
        <tr>
          <td class="total text-center">{% trans "TOTALES" %}</td>
          <td class="shade"></td>
          <td class="shade"></td>
          <td class="total num calc">{{ report.data.InstalacionesTermicas.totalconsumotorresyrefrigeracion|asnum }}</td>
        </tr>
      </table>
    </div>

    <div class="section solo-terciario">
      <h5>{% trans "Ventilación y bombeo (sólo edificios terciarios)" %}</h5>

      {% if not report.data.InstalacionesTermicas.VentilacionyBombeo and not es_vivienda %}

      <table>
        <tr>
          <td class="report-warning">
            {% trans "No se han definido sistemas de ventilación y bombeo" %}
          </td>
        </tr>
      </table>
      {% else %}
      <table>
        <tr>
          <td class="title" width="25%">{% trans "Nombre" %}</td>
          <td class="title" width="25%">{% trans "Tipo" %}</td>
          <td class="title" width="25%">{% trans "Servicio asociado" %}</td>
          <td class="title" width="25%">{% trans "Consumo de energía" %} [{% trans "kWh/año" %}]</td>
        </tr>
        {% for e in report.data.InstalacionesTermicas.VentilacionyBombeo|default:' ' %}
        <tr>
          <td>{{ e.Nombre|default:'-' }}</td>
          <td>{{ e.Tipo }}</td>
          <td>{{ e.ServicioAsociado }}</td>
          <td class="num">{{ e.ConsumoDeEnergia|asnum }}</td>
        </tr>
        {% endfor %}
        <tr>
          <td class="total text-center">{% trans "TOTALES" %}</td>
          <td class="shade"></td>
          <td class="shade"></td>
          <td class="total num calc">{{ report.data.InstalacionesTermicas.totalconsumoventilacionybombeo|asnum }}</td>
        </tr>
      </table>
      {% endif %}
    </div>

    <div class="section solo-terciario">
      <h4>{% trans "4. INSTALACIÓN DE ILUMINACIÓN (sólo edificios terciarios)" %}</h4>

      <table>
        <tr>
          <td class="title" width="30%">{% trans "Espacio" %}</td>
          <td class="title">{% trans "Potencia instalada" %} [{% trans "W/m<sup>2</sup>" %}]</td>
          <td class="title">{% trans "VEEI" %} [{% trans "W/m<sup>2</sup>·100lux" %}]</td>
          <td class="title">{% trans "Iluminancia media" %} [{% trans "lux" %}]</td>
          <td class="title">{% trans "Modo de obtención" %}</td>
        </tr>
        {% for e in report.data.InstalacionesIluminacion.Espacios %}
        <tr>
          <td>{{ e.Nombre }}</td>
          <td class="num">{{ e.PotenciaInstalada|asnum }}</td>
          <td class="num">{{ e.VEEI|asnum }}</td>
          <td class="num">{{ e.IluminanciaMedia|asnum }}</td>
          <td>{{ e.ModoDeObtencion }}</td>
        </tr>
        {% endfor %}
        <tr>
          <td class="total text-center">{% trans "TOTALES" %}</td>
          <td class="total num">{{ report.data.InstalacionesIluminacion.totalpotenciamedia|asnum }}</td>
          <td class="shade"></td>
          <td class="shade"></td>
          <td class="shade"></td>
        </tr>
      </table>
    </div>

    <div class="section solo-terciario">
      <h4>{% trans "5. CONDICIONES DE FUNCIONAMIENTO Y OCUPACIÓN (sólo edificios terciarios)" %}</h4>

      <table>
        <tr>
          <td class="title" width="33%">{% trans "Espacio" %}</td>
          <td class="title" width="33%">{% trans "Superficie" %} [{% trans "m<sup>2</sup>" %}]</td>
          <td class="title" width="33%">{% trans "Perfil de uso" %}</td>
        </tr>
        {% for e in report.data.CondicionesFuncionamientoyOcupacion %}
        <tr>
          <td>{{ e.Nombre }}</td>
          <td class="num">{{ e.Superficie|asnum }}</td>
          <td>{{ e.PerfilDeUso }}</td>
        </tr>
        {% endfor %}
      </table>
    </div>

    <div class="section">
      <h4>{% trans "6. ENERGÍAS RENOVABLES" %}</h4>

      <h5>{% trans "Térmica" %}</h5>
      <table>
        <tr>
          <td class="title" width="20%" rowspan="2">{% trans "Nombre" %}</td>
          <td class="title" colspan="3">{% trans "Consumo de Energía Final cubierto, en función del servicio asociado [%]" %}</td>
          <td class="title" width="20%" align="center" rowspan="2">{% trans "Demanda de ACS cubierta [%]" %}</td>
        </tr>
        <tr>
          <td class="title" width="20%">{% trans "Calefacción" %}</td>
          <td class="title" width="20%">{% trans "Refrigeración" %}</td>
          <td class="title" width="20%">{% trans "ACS" %}</td>
        </tr>
        {% for e in report.data.EnergiasRenovables.Termica %}
        <tr>
          <td>{{ e.Nombre }}</td>
          <td class="num">{{ e.ConsumoFinalCalefaccion|asnum }}</td>
          <td class="num">{{ e.ConsumoFinalRefrigeracion|asnum }}</td>
          <td class="num">{{ e.ConsumoFinalACS|asnum }}</td>
          <td class="num">{{ e.DemandaACS|asnum }}</td>
        </tr>
        {% endfor %}
        {% with totaltermica=report.data.EnergiasRenovables.totaltermica %}
        <tr>
          <td class="total text-center">{% trans "TOTAL" %}</td>
          <td class="total num">{{ totaltermica.ConsumoFinalCalefaccion|asnum }}</td>
          <td class="total num">{{ totaltermica.ConsumoFinalRefrigeracion|asnum }}</td>
          <td class="total num">{{ totaltermica.ConsumoFinalACS|asnum }}</td>
          <td class="total num">{{ totaltermica.DemandaACS|asnum }}</td>
        </tr>
        {% endwith %}
      </table>
    </div>

    <div class="section">
      <h5>{% trans "Eléctrica" %}</h5>

      <table style="width:75%" align="center">
        <tr>
          <td class="title">{% trans "Nombre" %}</td>
          <td class="title">{% trans "Energía eléctrica generada y autoconsumida" %} [{% trans "kWh/año" %}]</td>
        </tr>
        {% for e in report.data.EnergiasRenovables.Electrica|default:' ' %}
        <tr>
          <td>{{ e.Nombre }}</td>
          <td class="num">{{ e.EnergiaGeneradaAutoconsumida|asnum }}</td>
        </tr>
        {% endfor %}
        <tr>
          <td class="total text-center">{% trans "TOTAL" %}</td>
          <td class="total num">{{ report.data.EnergiasRenovables.totalelectrica|asnum }}</td>
        </tr>
      </table>
    </div>

    <div class="page-break"></div>
    <!-- ANEXO II - Calificación energética -->
    <h3 class="text-center">{% trans "ANEXO II" %}<br />{% trans "CALIFICACIÓN ENERGÉTICA DEL EDIFICIO" %}</h3>

    <table>
      <tr>
        <td class="title">{% trans "Zona Climática" %}</td>
        <td>{{ report.data.IdentificacionEdificio.ZonaClimatica }}</td>
        <td class="title">{% trans "Uso" %}</td>
        <td width="40%">{{ report.data.IdentificacionEdificio.TipoDeEdificio }}</td>
      </tr>
    </table>

    <div class="section">
      <h4>{% trans "1. CALIFICACIÓN ENERGÉTICA DEL EDIFICIO EN EMISIONES" %}</h4>

      <table class="no-fixed">
        <tr>
          <td class="title" width="50%">{% trans "INDICADOR GLOBAL" %}</td>
          <td class="title" width="50%"colspan="4">{% trans "INDICADORES PARCIALES" %}</td>
        </tr>
        <tr>
          <td rowspan="6" align="center" class="info">
            <img class="escala" src="{% escalasvg report.data.EmisionesCO2.Global report 'EmisionesCO2' %}" />
            <div>{% trans "Emisiones globales" %} [{% trans "kgCO<sub>2e</sub>/m<sup>2</sup>·año" %}]</p></div>
          </td>
          <td class="title" colspan="2">{% trans "CALEFACCIÓN" %}</td>
          <td class="title" colspan="2">{% trans "ACS" %}</td>
        </tr>
        <tr>
          <td class="info">{% trans "Emisiones calefacción" %} [{% trans "kgCO<sub>2e</sub>/m<sup>2</sup>·año" %}]</td>
          <td rowspan="2">{{ report.data.Calificacion.EmisionesCO2.Calefaccion|default:'-' }}</td>
          <td class="info">{% trans "Emisiones ACS" %} [{% trans "kgCO<sub>2e</sub>/m<sup>2</sup>·año" %}]</td>
          <td rowspan="2">{{ report.data.Calificacion.EmisionesCO2.ACS|default:'-' }}</td>
        </tr>
        <tr>
          <td class="info">{{ report.data.EmisionesCO2.Calefaccion|asnum }}</td>
          <td class="info">{{ report.data.EmisionesCO2.ACS|asnum }}</td>
        </tr>
        <tr>
          <td class="title" colspan="2">{% trans "REFRIGERACIÓN" %}</td>
          <td class="title" colspan="2">{% trans "ILUMINACIÓN" %}</td>
        </tr>
        <tr>
          <td class="info">{% trans "Emisiones refrigeración" %} [{% trans "kgCO<sub>2e</sub>/m<sup>2</sup>·año" %}]</td>
          <td rowspan="2">{{ report.data.Calificacion.EmisionesCO2.Refrigeracion|default:'-' }}</td>
          <td class="info">{% trans "Emisiones iluminación" %} [{% trans "kgCO<sub>2e</sub>/m<sup>2</sup>·año" %}]</td>
          <td rowspan="2" class="solo-terciario">{{ report.data.Calificacion.EmisionesCO2.Iluminacion|default:'-' }}</td>
        </tr>
        <tr>
          <td class="info">{{ report.data.EmisionesCO2.Refrigeracion|asnum }}</td>
          <td class="info solo-terciario">{{ report.data.EmisionesCO2.Iluminacion|asnum }}</td>
        </tr>
      </table>

      <p>
        {% blocktrans %}
        La calificación global del edificio se expresa en términos de dióxido de carbono liberado a la atmósfera como
          consecuencia del consumo energético del mismo.
        {% endblocktrans %}
      </p>

      <table style="width:75%" align="center">
        <tr>
          <td></td>
          <td class="title" width="20%">{% trans "kgCO<sub>2e</sub>/m<sup>2</sup>·año" %}</td>
          <td class="title" width="20%">{% trans "kgCO<sub>2e</sub>/año" %}</td>
        </tr>
        <tr>
          <td class="info">{% trans "Emisiones CO<sub>2</sub> por consumo eléctrico" %}</td>
          <td class="num">{{ report.data.EmisionesCO2.ConsumoElectrico|asnum }}</td>
          <td class="num">{{ report.data.EmisionesCO2.TotalConsumoElectrico|asint }}</td>
        <tr>
          <td class="info">{% trans "Emisiones CO<sub>2</sub> por otros combustibles" %}</td>
          <td class="num">{{ report.data.EmisionesCO2.ConsumoOtros|asnum }}</td>
          <td class="num">{{ report.data.EmisionesCO2.TotalConsumoOtros|asint }}</td>
        </tr>
      </table>
    </div>

    <div class="section">
      <h4>{% trans "2. CALIFICACIÓN ENERGÉTICA DEL EDIFICIO EN CONSUMO DE ENERGÍA PRIMARIA NO RENOVABLE" %}</h4>

      <p>
        {% blocktrans %}
          Por energía primara no renovable se entiende la energía consumida por el edificio procedente de fuentes no
          renovables que no ha sufrido ningún proceso de conversión o transformación.
        {% endblocktrans %}
      </p>

      <table class="no-fixed">
        <tr>
          <td class="title" width="50%">{% trans "INDICADOR GLOBAL" %}</td>
          <td class="title" width="50%" colspan="4">{% trans "INDICADORES PARCIALES" %}</td>
        </tr>
        <tr>
          <td rowspan="6" align="center" class="info">
            <img class="escala" src="{% escalasvg report.data.Consumo.EnergiaPrimariaNoRenovable.Global report 'EnergiaPrimariaNoRenovable' %}" />
            <div>{% trans "Consumo global de energía primaria no renovable" %} [{% trans "kWh/m<sup>2</sup>·año" %}]</div>
          </td>
          <td class="title" colspan="2">{% trans "CALEFACCIÓN" %}</td>
          <td class="title" colspan="2">{% trans "ACS" %}</td>
        </tr>
        <tr>
          <td class="info">{% trans "Energía primaria calefacción" %} [{% trans "kWh/m<sup>2</sup>·año" %}]</td>
          <td rowspan="2">{{ report.data.Calificacion.EnergiaPrimariaNoRenovable.Calefaccion|default:'-' }}</td>
          <td class="info">{% trans "Energía primaria ACS" %} [{% trans "kWh/m<sup>2</sup>·año" %}]</td>
          <td rowspan="2">{{ report.data.Calificacion.EnergiaPrimariaNoRenovable.ACS|default:'-' }}</td>
        </tr>
        <tr>
          <td class="info">{{ report.data.Consumo.EnergiaPrimariaNoRenovable.Calefaccion|asnum }}</td>
          <td class="info">{{ report.data.Consumo.EnergiaPrimariaNoRenovable.ACS|asnum }}</td>
        </tr>
        <tr>
          <td class="title" colspan="2">{% trans "REFRIGERACIÓN" %}</td>
          <td class="title" colspan="2">{% trans "ILUMINACIÓN" %}</td>
        </tr>
        <tr>
          <td class="info">{% trans "Energía primaria refrigeración" %} [{% trans "kWh/m<sup>2</sup>·año" %}]</td>
          <td rowspan="2">{{ report.data.Calificacion.EnergiaPrimariaNoRenovable.Refrigeracion|default:'-' }}</td>
          <td class="info">{% trans "Energía primaria iluminación" %} [{% trans "kWh/m<sup>2</sup>·año" %}]</td>
          <td rowspan="2" class="solo-terciario">{{ report.data.Calificacion.EnergiaPrimariaNoRenovable.Iluminacion|default:'-' }}</td>
        </tr>
        <tr>
          <td class="info">{{ report.data.Consumo.EnergiaPrimariaNoRenovable.Refrigeracion|asnum }}</td>
          <td class="info solo-terciario">{{ report.data.Consumo.EnergiaPrimariaNoRenovable.Iluminacion|asnum }}</td>
        </tr>
      </table>
    </div>

    <div class="section">
      <h4>{% trans "3. CALIFICACIÓN PARCIAL DE LA DEMANDA ENERGÉTICA DE CALEFACCIÓN Y REFRIGERACIÓN" %}</h4>

      <p>
        {% blocktrans %}
        La demanda energética de calefacción y refrigeración es la energía necesaria para mantener las condiciones
        internas de confort del edificio.
        {% endblocktrans %}
      </p>

      <div class="row">
        <div class="calif">
          <table>
            <tr>
              <td class="title">{% trans "DEMANDA DE CALEFACCIÓN" %}</td>
              <td class="title">{% trans "DEMANDA DE REFRIGERACIÓN" %}</td>
            </tr>
            <tr>
              <!-- XXX: ver aquí los casos de terciario con 08 ren/h -->
              <td><img class="escala" src="{% escalasvg report.data.Demanda.EdificioObjeto.Calefaccion report 'DemandaCalefaccion' %}" /></td>
              <td><img class="escala" src="{% escalasvg report.data.Demanda.EdificioObjeto.Refrigeracion report 'DemandaRefrigeracion' %}" /></td>
            </tr>
            <tr>
              <td class="info">{% trans "Demanda de calefacción" %} [{% trans "kWh/m<sup>2</sup>·año" %}]</td>
              <td class="info">{% trans "Demanda de refrigeración" %} [{% trans "kWh/m<sup>2</sup>·año" %}]</td>
            </tr>
          </table>
        </div>
      </div>
    </div>

    <div class="page-break"></div>
    <!-- ANEXO III - Medidas de mejora -->
    <h3 class="text-center">{% trans "ANEXO III" %}<br />{% trans "RECOMENDACIONES PARA LA MEJORA DE LA EFICIENCIA ENERGÉTICA" %}</h3>

    {% if not report.data.MedidasDeMejora %}
    <table>
      <tr>
        <td>
          {% trans "No se han definido medidas de mejora de la eficiencia energética" %}
        </td>
      </tr>
    </table>
    {% else %}
    {% for medida in report.data.MedidasDeMejora %}
    <h4>{% trans "MEDIDA DE MEJORA DE LA EFICIENCIA ENERGÉTICA" %}
      <a href="#" data-index="{{forloop.counter}}" data-type="measure" class="hidden-print delete-element">
        <img src="{% static "img/remove-button.png"%}" /> {% trans "Eliminar medida" %}
      </a>
  </h4>
    <table>
      <tr>
        <td width="20%" class="title">{% trans "Denominación:" %}</td>
        <td>
          <strong>
            <a href="#" class="editable" id="MedidasDeMejora.Medida[{{ forloop.counter }}].Nombre">
              {{ medida.Nombre }}
            </a>
          </strong>
        </td>
      </tr>
    </table>

    <br />

    <h4 class="text-center">{% trans "CALIFICACIÓN ENERGÉTICA GLOBAL" %}</h4>
    <div class="row">
      <div class="calif">
        <table>
          <tr>
            <td class="title">{% trans "CONSUMO DE ENERGÍA PRIMARIA NO RENOVABLE" %}<br />[{% trans "kWg/m<sup>2</sup>·año" %}]</td>
            <td class="title">{% trans "EMISIONES DE DIÓXIDO DE CARBONO" %}<br />[{% trans "kgCO<sub>2e</sub>/m<sup>2</sup>·año" %}]</td>
          </tr>
          <tr>
            <td><img class="escala" src="{% escalasvg medida.EnergiaPrimariaNoRenovable.Global report 'EnergiaPrimariaNoRenovable' %}" /></td>
            <td><img class="escala" src="{% escalasvg medida.EmisionesCO2.Global report 'EmisionesCO2' %}" /></td>
          </tr>
        </table>
      </div>
    </div>
    <br />

    <h4 class="text-center">{% trans "CALIFICACIONES ENERGÉTICAS PARCIALES" %}</h4>
    <div class="row">
      <div class="calif">
        <table>
          <tr>
            <td class="title">{% trans "DEMANDA DE CALEFACCIÓN" %}<br />[{% trans "kWh/m<sup>2</sup>·año" %}]</td>
            <td class="title">{% trans "DEMANDA DE REFRIGERACIÓN" %}<br />[{% trans "kgCO<sub>2e</sub>/m<sup>2</sup>·año" %}]</td>
          </tr>
          <tr>
            <td><img class="escala" src="{% escalasvg medida.Demanda.Calefaccion report 'DemandaCalefaccion' %}" /></td>
            <td><img class="escala" src="{% escalasvg medida.Demanda.Refrigeracion report 'DemandaRefrigeracion' %}" /></td>
          </tr>
        </table>
      </div>
    </div>

    <h4>{% trans "ANÁLISIS TÉCNICO" %}</h4>

    <table>
      <tr>
        <td width="15%" class="title" rowspan="2">{% trans "Indicador" %}</td>
        <td class="title" colspan="2">{% trans "Calefacción" %}</td>
        <td class="title" colspan="2">{% trans "Refrigeración" %}</td>
        <td class="title" colspan="2">{% trans "ACS" %}</td>
        <td class="title" colspan="2">{% trans "Iluminación" %}</td>
        <td class="title" colspan="2">{% trans "Total" %}</td>
      </tr>
      <tr>
        <td class="title">{% trans "Valor" %}</td>
        <td class="title">{% trans "Ahorro" %}<br /><small>{% trans "respecto a la situación original" %}</small></td>
        <td class="title">{% trans "Valor" %}</td>
        <td class="title">{% trans "Ahorro" %}<br /><small>{% trans "respecto a la situación original" %}</small></td>
        <td class="title">{% trans "Valor" %}</td>
        <td class="title">{% trans "Ahorro" %}<br /><small>{% trans "respecto a la situación original" %}</small></td>
        <td class="title">{% trans "Valor" %}</td>
        <td class="title">{% trans "Ahorro" %}<br /><small>{% trans "respecto a la situación original" %}</small></td>
        <td class="title">{% trans "Valor" %}</td>
        <td class="title">{% trans "Ahorro" %}<br /><small>{% trans "respecto a la situación original" %}</small></td>
      </tr>
      <tr>
        <td class="title">{% trans "Consumo Energía final" %}<br /><small>[{% trans "kWh/m<sup>2</sup>·año" %}]</small></td>
        <td class="num">{{ medida.EnergiaFinal.Calefaccion|asnum }}</td>
        <td class="num calc small dif">{{ medida.EnergiaFinal.Calefaccion|difwith:report.data.Consumo.EnergiaFinal.Calefaccion|safe }}</td>
        <td class="num">{{ medida.EnergiaFinal.Refrigeracion|asnum }}</td>
        <td class="num calc small dif">{{ medida.EnergiaFinal.Refrigeracion|difwith:report.data.Consumo.EnergiaFinal.Refrigeracion|safe }}</td>
        <td class="num">{{ medida.EnergiaFinal.ACS|asnum }}</td>
        <td class="num calc small dif">{{ medida.EnergiaFinal.ACS|difwith:report.data.Consumo.EnergiaFinal.ACS|safe }}</td>
        <td class="num solo-terciario">{{ medida.EnergiaFinal.Iluminacion|asnum }}</td>
        <td class="num calc small dif solo-terciario">{{ medida.EnergiaFinal.Iluminacion|difwith:report.data.Consumo.EnergiaFinal.Iluminacion|safe }}</td>
        <td class="num">{{ medida.EnergiaFinal.Global|asnum }}</td>
        <td class="num calc small dif">{{ medida.EnergiaFinal.Global|difwith:report.data.Consumo.EnergiaFinal.Global|safe }}</td>
      </tr>
      <tr>
        <td class="title">{% trans "Consumo Energía primaria no renovable" %}<br /><small>[{% trans "kWh/m<sup>2</sup>·año" %}]</small></td>
        <td class="num">{{ medida.EnergiaPrimariaNoRenovable.Calefaccion|asnum }}<br />{{ medida.CalificacionEnergiaPrimariaNoRenovable.Calefaccion|default:'-' }}</td>
        <td class="num calc small dif">{{ medida.EnergiaPrimariaNoRenovable.Calefaccion|difwith:report.data.Consumo.EnergiaPrimariaNoRenovable.Calefaccion|safe }}</td>
        <td class="num">{{ medida.EnergiaPrimariaNoRenovable.Refrigeracion|asnum }}<br />{{ medida.CalificacionEnergiaPrimariaNoRenovable.Refrigeracion|default:'-' }}</td>
        <td class="num calc small dif">{{ medida.EnergiaPrimariaNoRenovable.Refrigeracion|difwith:report.data.Consumo.EnergiaPrimariaNoRenovable.Refrigeracion|safe }}</td>
        <td class="num">{{ medida.EnergiaPrimariaNoRenovable.ACS|asnum }}<br />{{ medida.CalificacionEnergiaPrimariaNoRenovable.ACS|default:'-' }}</td>
        <td class="num calc small dif">{{ medida.EnergiaPrimariaNoRenovable.ACS|difwith:report.data.Consumo.EnergiaPrimariaNoRenovable.ACS|safe }}</td>
        <td class="num solo-terciario">{{ medida.EnergiaPrimariaNoRenovable.Iluminacion|asnum }}<br />{{ medida.CalificacionEnergiaPrimariaNoRenovable.Iluminacion|default:'-' }}</td>
        <td class="num calc small dif solo-terciario">{{ medida.EnergiaPrimariaNoRenovable.Iluminacion|difwith:report.data.Consumo.EnergiaPrimariaNoRenovable.Iluminacion|safe }}</td>
        <td class="num">{{ medida.EnergiaPrimariaNoRenovable.Global|asnum }}<br />{{ medida.CalificacionEnergiaPrimariaNoRenovable.Global|default:'-' }}</td>
        <td class="num calc small dif">{{ medida.EnergiaPrimariaNoRenovable.Global|difwith:report.data.Consumo.EnergiaPrimariaNoRenovable.Global|safe }}</td>
      </tr>
      <tr>
        <td class="title">{% trans "Emisiones de CO<sub>2</sub>" %}<br /><small>[{% trans "kgCO<sub>2e</sub>/m<sup>2</sup>·año" %}]</small></td>
        <td class="num">{{ medida.EmisionesCO2.Calefaccion|asnum }}<br />{{ medida.CalificacionEmisionesCO2.Calefaccion|default:'-' }}</td>
        <td class="num calc small dif">{{ medida.EmisionesCO2.Calefaccion|difwith:report.data.EmisionesCO2.Calefaccion|safe }}</td>
        <td class="num">{{ medida.EmisionesCO2.Refrigeracion|asnum }}<br />{{ medida.CalificacionEmisionesCO2.Refrigeracion|default:'-' }}</td>
        <td class="num calc small dif">{{ medida.EmisionesCO2.Refrigeracion|difwith:report.data.EmisionesCO2.Refrigeracion|safe }}</td>
        <td class="num">{{ medida.EmisionesCO2.ACS|asnum }}<br />{{ medida.CalificacionEmisionesCO2.ACS|default:'-' }}</td>
        <td class="num calc small dif">{{ medida.EmisionesCO2.ACS|difwith:report.data.EmisionesCO2.ACS|safe }}</td>
        <td class="num solo-terciario">{{ medida.EmisionesCO2.Iluminacion|asnum }}<br />{{ medida.CalificacionEmisionesCO2.Iluminacion|default:'-' }}</td>
        <td class="num calc small dif solo-terciario">{{ medida.EmisionesCO2.Iluminacion|difwith:report.data.EmisionesCO2.Iluminacion|safe }}</td>
        <td class="num">{{ medida.EmisionesCO2.Global|asnum }}<br />{{ medida.CalificacionEmisionesCO2.Global|default:'-' }}</td>
        <td class="num calc small dif">{{ medida.EmisionesCO2.Global|difwith:report.data.EmisionesCO2.Global|safe }}</td>
      </tr>
      <tr>
        <td class="title">{% trans "Demanda" %}<br /><small>[{% trans "kWh/m<sup>2</sup>·año" %}]</small></td>
        <td class="num">{{ medida.Demanda.Calefaccion|asnum }}<br />{{ medida.CalificacionDemanda.Calefaccion|default:'-' }}</td>
        <td class="num calc small dif">{{ medida.Demanda.Calefaccion|difwith:report.data.Demanda.EdificioObjeto.Calefaccion|safe }}</td>
        <td class="num">{{ medida.Demanda.Refrigeracion|asnum }}<br />{{ medida.CalificacionDemanda.Refrigeracion|default:'-' }}</td>
        <td class="num calc small dif">{{ medida.Demanda.Refrigeracion|difwith:report.data.Demanda.EdificioObjeto.Refrigeracion|safe }}</td>
        <td colspan="2" class="shade">&nbsp;</td>
        <td colspan="2" class="shade">&nbsp;</td>
        <td colspan="2" class="shade">&nbsp;</td>
      </tr>
    </table>

    <p>
    {% blocktrans %}
      Nota: Los indicadores energéticos anteriores están calculados en base a coeficientes estándar de operación y
      funcionamiento del edificio, por lo que solo son válidos a efectos de su calificación energética. Para el análisis
      económico de las medidas de ahorro y eficiencia energética, el técnico certificador deberá utilizar las
      condiciones reales y datos históricos de consumo del edificio.
    {% endblocktrans %}
    </p>

    <br />

    <table>
      <tr><td class="title">{% trans "DESCRIPCIÓN DE LA MEDIDA DE MEJORA" %}</td></tr>
      <tr>
        <td class="editor-html5">
          <strong>{% trans "Características técnicas de la medida (modelo de equipos, materiales, parámetros característicos)" %}</strong>
          <br />
          <br />
          <a href="#" class="editable" data-type="wysihtml5" data-showbuttons="bottom" id="MedidasDeMejora.Medida[{{ forloop.counter }}].Descripcion">{{ medida.Descripcion|safe }}</a>
        </td>
      </tr>
      <tr>
        <td>
          <strong>{% trans "Coste estimado de la medida" %}</strong>
          <br />
          <br />
          <a href="#" class="editable"  id="MedidasDeMejora.Medida[{{ forloop.counter }}].CosteEstimado">{{ medida.CosteEstimado|safe }}</a>
        </td>
      <tr/>
      <tr>
        <td class="editor-html5">
          <strong>{% trans "Otros datos de interés" %}</strong>
          <br />
          <br />
          <a href="#" class="editable" data-type="wysihtml5" data-showbuttons="bottom" id="MedidasDeMejora.Medida[{{ forloop.counter }}].OtrosDatos">{{ medida.OtrosDatos|safe }}</a>
        </td>
      <tr/>
    </table>
    {% endfor %}
    {% endif %}

    {% if not pdf %}
    <form action="{% url 'measures_xml_upload'%}" method="POST" enctype="multipart/form-data" class="measures-form">
      {% csrf_token %}
      <a href="#" class="green-button add-measures">
        <img src="{% static "img/add-button.png"%}" />
        <span>
          {% trans "Añadir medida de mejora desde archivo XML (o XML+PDF)" %}
        </span>
        <input type="file" class="measures-xml hidden" name="measures-xml"/>
      </a>
    </form>
    {% endif %}
    <br><br>

    <div class="page-break" ></div>
    <!-- ANEXO IV -->
    <h3 class="text-center" id="anexo-iv">{% trans "ANEXO IV" %}<br />{% trans "PRUEBAS, COMPROBACIONES E INSPECCIONES REALIZADAS POR EL TÉCNICO CERTIFICADOR" %}</h3>

    <p>
      {% blocktrans %}
        Se describen a continuación las pruebas, comprobaciones e inspecciones llevadas a cabo por el técnico certificador
        durante el proceso de toma de datos y de calificación de la eficiencia energética del edificio, con la finalidad
        de establecer la conformidad de la información de partida contenida en el certificado de eficiencia energética.
      {% endblocktrans %}
    </p>

    <table>
      {% for visita in report.data.PruebasComprobacionesInspecciones %}
      <tr>
        <td width="80%" class="title">{% trans "Fecha de realización de la visita del técnico certificador" %}</td>
        <td>
          <a href="#" class="editable" data-type="date" data-format="dd/mm/yy" data-mode="popup" id="PruebasComprobacionesInspecciones.Visita[{{ forloop.counter }}].FechaVisita">
            {{ visita.FechaVisita }}
          </a>
          <a href="#" class="pull-right hidden-print delete-element delete-visit" data-index="{{forloop.counter}}" data-type="visit">
            <img src="{% static "img/remove-button.png"%}" />
            {% trans "Eliminar visita" %}
          </a>
        </td>
      </tr>
      <tr>
        <td colspan="2" class="editor-html5">
          <a href="#" class="editable-html5" data-type="wysihtml5"  data-showbuttons="bottom" id="PruebasComprobacionesInspecciones.Visita[{{ forloop.counter }}].Datos">{% if visita.Datos != "-" %}{{ visita.Datos|safe }}{% endif %}</a>
        </td>
      </tr>
      {% endfor %}
      {% if not report.data.PruebasComprobacionesInspecciones %}
      <tr>
        <td width="80%" class="title">{% trans "Fecha de realización de la visita del técnico certificador" %}</td>
        <td>
          <a href="#" class="editable" data-type="date" data-format="dd/mm/yy" data-mode="popup" id="PruebasComprobacionesInspecciones.Visita[1].FechaVisita">-</a>
        </td>
      </tr>
      <tr>
        <td colspan="2" class="editor-html5">
          <a href="#" class="editable-html5" data-type="wysihtml5"  data-showbuttons="bottom" id="PruebasComprobacionesInspecciones.Visita[1].Datos"></a>
        </td>
      </tr>
      {% endif %}
    </table>

  <a class="hidden-print green-button" href="{% url 'new_visit' %}">
    <img src="{% static "img/add-button.png"%}" />
    {% trans "Añadir visita" %}
  </a>
  <br><br>

  {% if report.has_annex_v %}

    <div class="page-break" ></div>
    <!-- ANEXO V -->
    <h3 class="text-center" id="anexo-v">{% trans "ANEXO V" %}<br />{% trans "Justificación de Soluciones Singulares" %}</h3>
    <table>
      <tr>
        <td class="title">
          {% trans "Descripción" %}
          <a class="pull-right hidden-print delete-element" data-index="0" data-type="solutions" href="#">
            <img src="{% static "img/remove-button.png"%}" />
            {% trans "Eliminar anexo" %}
          </a>
        </td>
      </tr>
      <tr>
        <td class="editor-html5">
          <a href="#" class="editable-html5" data-type="wysihtml5" data-showbuttons="bottom" id="DatosPersonalizados.SolucionesSingulares">{% if report.get_annex_v %}{{ report.get_annex_v|safe }}{% endif %}</a>
        </td>
      </tr>
    </table>

  {% else %}
      <!-- ANEXO V -->
      <div class="anex-v hidden-print">
        <div class="page-break" ></div>
        <h3 class="text-center" id="anexo-v">{% trans "ANEXO V" %}<br />{% trans "Justificación de Soluciones Singulares" %}</h3>
        <table>
          <tr>
            <td class="title">
              {% trans "Descripción" %}
            </td>
          </tr>
          <tr>
            <td class="editor-html5">
              <a href="#" class="editable-html5" data-type="wysihtml5" data-showbuttons="bottom" id="DatosPersonalizados.SolucionesSingulares"></a>
            </td>
          </tr>
        </table>
      </div>
  {% endif %}

  </div>
  {% if not pdf %}
  <form id="secret-form" action="{% url 'measures_xml_upload' %}" class="hidden" method="POST" enctype="multipart/form-data">
  {% csrf_token %}
  </form>
  {% endif %}

  <br><br>
  <script>
    var generation_date = '{{ report.data.DatosDelCertificador.Fecha }}';
    var reference = '{{ report.data.IdentificacionEdificio.ReferenciaCatastral }}';
  </script>

</div>

{% endif %}
{% endblock %}

{% block extra_js %}

  <script src="{%  static "js/jquery.formset.js" %}"></script>

  <script>

  {% for a,b,id in validation_data.info %}
    {% if id %}
      $("#{{id}}").closest("td").addClass("report-warning");
    {% endif %}
  {% endfor %}



  Blob.prototype.convertToBase64 = function(callback){
          var FR= new FileReader();
          FR.onload = function(e) {
               callback(e.target.result)
          };
          FR.readAsDataURL(this);
  }


  $(function() {

    $("span.alert").each(function(){
      //          Before                                      After
      // <td><span class="alert">-</span></td>   ==>  <td class="report-alert">-</td>
      var parent = $(this).parent(),
      content = $(this).html();
      parent.html(content);
      parent.addClass("report-alert");
    });
    {% get_uso %}
    {% if es_vivienda %}
    $(".solo-terciario td.report-alert").html(""); // Empty content in alerts
    $(".solo-terciario td.report-alert").removeClass("report-alert");// remove alert in "solo-terciario" sections
    $("td.solo-terciario").removeClass("report-alert"); // remove alert in "solo-terciario" cells
    {% endif %}

    $(".delete-element").on("click", function(e){
      e.preventDefault();
      var data = {
              index: $(this).data("index"),
              type: $(this).data("type"),
              csrfmiddlewaretoken : "{{ csrf_token }}"
            };

      if(confirm("{% trans "¿Está seguro de que desea eliminar este elemento?" %}")){
        $.ajax({
            url: '{% url 'delete_element' %}',
            type: 'POST',
            data: data,
          }).done(function(){
              //Reload page
              window.location.href = "{% url 'certificate'%}";
          }).fail(function(){
            console.log("An error occurred, the measure couldn't be deleted!");
          });
      }

      return false;
    });


    $(".add-measures").on("click", function(e){
      e.preventDefault();
      var fileSelector = $('<input type="file" name="measures-xml" />')
        .change(function() {
          $("#secret-form").submit()
        });
      $("#secret-form").append(fileSelector);
      fileSelector.click();
    });


    var fileInputOptions = {
          'showUpload': false,
          'showPreview': false,
          'showRemove': false,
          'browseClass': 'btn btn-default'
        }
    $("#formset").formset({
      animateForms: true
    })
    .on('formAdded', function(event) {
        var newForm = $(event.target);
        newForm.find('input:file').fileinput(fileInputOptions);
    });

    $("input.file-input").fileinput(fileInputOptions);

    /**
     * Spanish translation for bootstrap-datepicker
     * Bruno Bonamin <bruno.bonamin@gmail.com>
     */
    ;(function($){
      $.fn.datepicker.dates['es'] = {
        days: ["Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado"],
        daysShort: ["Dom", "Lun", "Mar", "Mié", "Jue", "Vie", "Sáb"],
        daysMin: ["Do", "Lu", "Ma", "Mi", "Ju", "Vi", "Sa"],
        months: ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"],
        monthsShort: ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"],
        today: "Hoy",
        monthsTitle: "Meses",
        clear: "Borrar",
        weekStart: 1,
        format: "dd/mm/yyyy"
      };
      $.fn.datepicker.dates['ca'] = {
        days: ["Diumenge", "Dilluns", "Dimarts", "Dimecres", "Dijous", "Divendres", "Dissabte"],
        daysShort: ["Diu",  "Dil", "Dmt", "Dmc", "Dij", "Div", "Dis"],
        daysMin: ["dg", "dl", "dt", "dc", "dj", "dv", "ds"],
        months: ["Gener", "Febrer", "Març", "Abril", "Maig", "Juny", "Juliol", "Agost", "Setembre", "Octubre", "Novembre", "Desembre"],
        monthsShort: ["Gen", "Feb", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Oct", "Nov", "Des"],
        today: "Avui",
        monthsTitle: "Mesos",
        clear: "Esborrar",
        weekStart: 1,
        format: "dd/mm/yyyy"
      };
      $.fn.datepicker.dates['eu'] = {
        days: ['Igandea', 'Astelehena', 'Asteartea', 'Asteazkena', 'Osteguna', 'Ostirala', 'Larunbata'],
        daysShort: ['Ig', 'Al', 'Ar', 'Az', 'Og', 'Ol', 'Lr'],
        daysMin: ['Ig', 'Al', 'Ar', 'Az', 'Og', 'Ol', 'Lr'],
        months: ['Urtarrila', 'Otsaila', 'Martxoa', 'Apirila', 'Maiatza', 'Ekaina', 'Uztaila', 'Abuztua', 'Iraila', 'Urria', 'Azaroa', 'Abendua'],
        monthsShort: ['Urt', 'Ots', 'Mar', 'Api', 'Mai', 'Eka', 'Uzt', 'Abu', 'Ira', 'Urr', 'Aza', 'Abe'],
        today: "Gaur"
      };
      $.fn.datepicker.dates['gl'] = {
        days: ["Domingo", "Luns", "Martes", "Mércores", "Xoves", "Venres", "Sábado"],
        daysShort: ["Dom", "Lun", "Mar", "Mér", "Xov", "Ven", "Sáb"],
        daysMin: ["Do", "Lu", "Ma", "Me", "Xo", "Ve", "Sa"],
        months: ["Xaneiro", "Febreiro", "Marzo", "Abril", "Maio", "Xuño", "Xullo", "Agosto", "Setembro", "Outubro", "Novembro", "Decembro"],
        monthsShort: ["Xan", "Feb", "Mar", "Abr", "Mai", "Xun", "Xul", "Ago", "Sep", "Out", "Nov", "Dec"],
        today: "Hoxe",
        clear: "Limpar",
        weekStart: 1,
        format: "dd/mm/yyyy"
      };
    }(jQuery));


    $.fn.editable.defaults.mode = 'inline';
    $('.editable').editable({
      url: '{% url "update-xml" %}',
      pk: 1,
      datepicker: {
        language: '{% get_current_language as LANGUAGE_CODE %}{{LANGUAGE_CODE}}'
      },
      emptytext: '<span class="hidden-print">Pulse para editar...</span><span class="visible-print-block"><br /></span>',
      onblur: "submit",
      success: function(response, newValue) {
        if(!response.success){
          $(this).closest("td").removeClass("report-warning");
          $(this).closest("td").addClass("edited");
          $(".procedimiento").addClass("edited");
          if( $(".procedimiento a").html().indexOf("+ [VisorXML") == -1 ){
            $(".procedimiento a").html($(".procedimiento a").html()+ " + VisorXML[1.0]");
          }
        }
      },
      error: function(response, newValue) {
        alert("Ha occurrido un error inesperado!");
      },
    });

    $('.editable-html5').editable({
      url: '{% url "update-xml" %}',
      pk: 1,
      emptytext: '<span class="hidden-print">Pulse para editar...</span><span class="visible-print-block"><br /></span>',
      onblur: "submit",
    });


    {% if not pdf %}
    $('.editable-html5').on('save', function(e, params) {
     var node = $(this).closest("td");
     setTimeout(function(){
       node.height(node.find("a").height()* 2.01);
     }, 200);
    });

    $("td.editor-html5").each(function(){
      var height = $(this).height() * 2.01;
      $(this).height(height);
    });

    {% endif %}

    $('.upload-image').click(function(event) {
      event.preventDefault();

      var section = $(this).data('section');

      var fileSelector = $('<input type="file" />')
        .change(function() {
          var file = this.files[0];
          var form = new FormData();
          form.append('image', file);
          form.append('section', section);

          $.ajax({
            url: '{% url 'upload-image' %}',
            type: 'POST',
            data: form,
            processData: false,
            contentType: false
          }).done(function(){
            var location = window.location.href.split("/");
            location = "/" + location[location.length-1];
            if( location ==  "{% url 'certificate'%}#anexo-I")
              window.location.reload();
            else
              window.location.href = "{% url 'certificate'%}#anexo-I";

          }).fail(function(){
            console.log("An error occurred, the files couldn't be sent!");
          });
        })
      fileSelector.click();

    });

    $(".xml-select").on("click", function(e){
      e.preventDefault();
      $("#certificate-file").click();
    });
    $("#certificate-file").on("change",function(){
      $("#xml-form").submit();
    });


    $(".editor-html5 > a").on("click", function(e){
      setTimeout(function(){
        $(".wysihtml5-toolbar li:nth-child(5) a.btn").on("click", function(event){
          event.preventDefault();
          var editor = $(this).closest(".editable-input").find("textarea").data("wysihtml5").editor;
          var fileSelector = $('<input type="file" />')
            .change(function() {
              var file = this.files[0],
              name = file.name,
              date = file.lastModifiedDate;
              ImageTools.resize(file, {
                width: 560,
                height: 560,
              },function(blob, didItResize){
                console.log(name);
                console.log(date);
                blob.name = name;
                blob.lastModifiedDate = date;
                blob.convertToBase64(function(base64){
                  editor.composer.commands.exec("insertImage", base64);
                });
              })
            })
          fileSelector.click();
        })
      }, 800);

    });
  });
  </script>
{% endblock %}


